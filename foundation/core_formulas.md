---
STATUS: CANONICAL (正本)
IMMUTABLE_SECTIONS: [全セクション]
LAST_VERIFIED: 2026-02-04
SOURCE: docs/reference/Game_Domain_Spec.md, docs/specs/Logic_Core.md
---

# 核心計算式 - Fisher Logic Engine

> [!CAUTION]
> **このドキュメントは実装の根拠となる正本です**
> 
> 全てのセクションは**絶対に要約・削除しないこと**。
> AI更新時は、必ず元の情報を保持してください。

**Purpose**: AI引き継ぎ時に必ず理解すべき計算式を集約  
**Version**: 3.3.0  
**Last Updated**: 2026-02-04

---

## 1. GDS定数表 (Game Duration Standards)

計算全体で使用される固定時間値および倍率。

| Code Key | 記号 | 名称 | 設定値 | 内容・物理的定義 |
| :--- | :--- | :--- | :--- | :--- |
| `D_CAST` | $D_{Cast}$ | キャスト硬直 | **1.0s** | キャスト動作の開始硬直 |
| `D_LURE` | $D_{Lure}$ | ルアー硬直 | **2.5s** | ルアーアクション1回あたりの動作硬直 |
| `D_BLK` | $D_{Blk}$ | ルアー後空白 | **2.5s** | ルアー使用後、ヒット判定解禁までの最小猶予 |
| `D_CHUM` | $D_{Chum}$ | 撒き餌硬直 | **1.0s** | 撒き餌使用動作の物理硬直 |
| `D_REST` | $D_{Rest}$ | 竿上げ硬直 | **2.0s** | 竿上げ（中断）動作の硬直 |
| `C_CHUM` | $C_{Chum}$ | 撒き餌補正 | **0.6** | $T_{Bite}$ に乗算する撒き餌による短縮係数 |
| `M_N1` | $M_{n1}$ | 重み補正1 | **1.5** | ルアー1回時の適合型への重み倍率 |
| `M_N2` | $M_{n2}$ | 重み補正2 | **2.0** | ルアー2回時の適合型への重み倍率 |
| `M_N3` | $M_{n3}$ | 重み補正3 | **6.0** | ルアー3回時の適合型への重み倍率 |

**実装**: `src/core/calculator.js` の `GDS` オブジェクト

---

## 2. 基本ヒット率の算出

### 2.1 通常魚のヒット率 ($P_i$)

特定の釣り場と条件下での、特定の魚種 $i$ のヒット率は、現在有効な全出現候補（重み $w > 0$ の魚種）の重みの総和に対する、自身の重みの割合として定義される。

$$P_i = \frac{w_i}{\sum_{k=1}^{m} w_k}$$

**変数の定義**:
- $w_i$: 魚種 $i$ の基礎重み（`基礎重み・基礎待機時間.csv` より）
- $m$: 現在有効な出現候補の総数（重み $w > 0$ の魚種のみ）

**重み補正の適用**:

$$W_{final} = W_{base} \times M$$

**倍率 ($M$) 決定ロジック**:
1. **Surface Slap (トレードリリース)**: 対象魚の場合、$M = 0$
2. **Lure Match (ルアー一致)**: ルアー有効 かつ 型(Jaws)が一致する場合:
   - $M = M_{Nx}$ (回数に応じて 1.5, 2.0, 6.0)
3. **Lure Mismatch (ルアー不一致)**: ルアー有効 かつ 型が一致しない場合:
   - 直近のステップで「型確定」している場合: $M = 0$
   - それ以外: $M = 1.0$ (変化なし)

### 2.2 隠し魚のヒット率

隠し魚が出現された状態（発見成功時）では、隠し魚のヒット率は直接指定値 $P_{DiscHit}$ が適用され、残りの確率を通常魚同士で分配する。

$$P_{Hit, i} = \frac{W_{final, i}}{\sum W_{final}} \times (1.0 - P_{Hidden})$$

**未発見シナリオ** ($d=0$) の場合、$P_{Hidden} = 0$

---

## 3. シナリオ発生確率 ($P_{Scenario}$)

あるシナリオが発生する確率は、各ステップの結果確率を掛け合わせることで算出される。

$$P_{Scenario} = \prod_{i=1}^{n} P_{Step, i}$$

**ステップ確率 ($P_{Step, i}$)** は状態に依存する:

### 3.1 発見前
- Master DB の `disc_rates[i]` および `guar_rates_nodisc[i]` を使用
- 結果: 発見 ($P_{Disc}$), 型確定 ($P_{Guar}$), なし

### 3.2 発見後
- `guar_rates_after_disc[d{Found}_g{i}]` を使用
- 結果: 型確定 ($P_{GuarAfter}$), なし（発見は2回発生しない）

**パターンの発生確率算出式**（32パターンの一般化定義）:

$$P(\text{Pattern}) = \prod_{t=1}^{n} Prob(t)$$

**Prob(t) の決定ロジック**:
1. **発見前（t < i または 発見なし）**
   - 型確定あり： (1 - DISC_RATE_t) * GUAR_RATE_t
   - 型確定なし： (1 - DISC_RATE_t) * (1 - GUAR_RATE_t)
2. **発見の瞬間（t = i）**
   - DISC_RATE_t
3. **発見後（t > i）**
   - 型確定あり： D_i_GUAR_RATE_t
   - 型確定なし： 1 - D_i_GUAR_RATE_t

---

## 4. 時間計算モデル

### 4.1 実効待機時間 ($T_{Final}$) の期待値算出

**v3.2.1 改訂版**

ルアー拘束時間 $L$ と、魚種の基礎待機時間分布 $X \sim U[Min, Max]$ の関係 $W = \max(X, L)$ に基づき、以下の3ケースで算出する。

#### Case 1: $L \le Min$
$L$の影響なし。標準的な平均値。

$$E[W] = \frac{Min + Max}{2}$$

#### Case 2: $L \ge Max$
常に$L$に拘束される。期待値は $L$。

$$E[W] = L$$

#### Case 3: $Min < L < Max$
積分計算による厳密な期待値。

$$E[W] = \frac{L(L - Min) + \frac{Max^2 - L^2}{2}}{Max - Min}$$

**撒き餌使用時の補正**:
$Min, Max$ に $C_{Chum}$ (0.6) を乗じた値を使用する。

### 4.2 ルアー拘束時間 ($L$)

$$L = D_{CAST} + (n \times D_{LURE}) + D_{BLK}$$

**変数**:
- $n$: ルアー使用回数 (0-3)
- $D_{CAST}$: キャスト硬直 (1.0s)
- $D_{LURE}$: ルアー硬直 (2.5s)
- $D_{BLK}$: ルアー後空白 (2.5s)

### 4.3 サイクル総時間 ($T_{Cycle}$)

$$T_{Cycle} = T_{Pre} + D_{CAST} + T_{WaitAvg} + T_{Hook}$$

**構成要素**:
- $T_{Pre}$: 撒き餌使用時は `D_CHUM` (1.0s)、未使用なら 0
- $D_{CAST}$: キャスト硬直 (1.0s)
- $T_{WaitAvg}$: 待機時間期待値（4.1の計算結果）
- $T_{Hook}$:
  - ターゲット/CatchAll対象: `fish.hook_time`
  - その他（竿上げ）: `D_REST` (2.0s)

**即竿上げロジック (Quit Recommendation)**:
設定 `isQuit` (未発見時即竿上げ) が有効 かつ シナリオが $d=0$ の場合:

$$T_{Cycle} = T_{Pre} + D_{CAST} + (n \times D_{LURE}) + D_{REST}$$

($D_{BLK}$ および待機時間を無視する。ヒット率は 0 となる)

### 4.4 期待時間 ($E[Time]$)

ターゲットを1匹入手するために必要な平均時間の期待値。

$$E[Time] = \frac{E[Cycle] - (P_{Target} \times T_{Hook, Target})}{P_{Target}}$$

**注**: 分子から「成功時のフッキング時間」を減算しているのは、幾何分布に基づく「成功までの試行時間」において、最後の1回（成功回）のコストを含めるかどうかの定義による。本システムでは純粋な「待ち時間コスト」の期待値を算出している。

---

## 5. 変数モード (Unknown Weights)

`isVariableMode` が有効な場合、ターゲット魚の重みを、ユーザー指定確率 (`overrideP`) に合うように動的に逆算・調整する。

$$W_{target} = \frac{P_{override} \times \sum W_{others}}{1.0 - P_{override}}$$

**実装**: `src/core/calculator.js` の `calculateScenarioStats()` 関数

---

## 6. シナリオIDフォーマット

ルアー使用結果（シナリオ）は、以下のフォーマット文字列で一意に識別される。

```
n{回数}_d{発見ステップ}_g{型確定ステップ}
```

**要素**:
- **n (Number)**: ルアー総使用回数 (0-3)
- **d (Discovery)**: 「発見」が発生したステップ番号 (1-n)。発生なしの場合は 0
- **g (Guarantee)**: 「型確定」が発生したステップ番号の列 (例: '12' はステップ1と2)。なしの場合は '0'

**例**:
- `n0_d0_g0`: ルアー未使用
- `n2_d1_g2`: ルアー2回使用。ステップ1で発見、ステップ2で型確定
- `n3_d0_g12`: ルアー3回使用。発見なし、ステップ1と2で型確定

**実装**: `src/core/scenario.js`

---

## 7. マスタ参照変数

| Code Key | 記号 | 名称 | 参照先マスタ | 内容・定義 |
| :--- | :--- | :--- | :--- | :--- |
| `WEIGHT` | $w_i$ | 基礎重み | `基礎重み・基礎待機時間.csv` | 魚種の出現しやすさの相対比率。隠し魚（Hidden）の場合は 0 と定義される |
| `T_BITE` | $T_{Bite, i}$ | 基礎待機時間(Min/Max) | `基礎重み・基礎待機時間.csv` | キャストからアタリ発生までの基礎秒数（最小～最大） |
| `D_HOOK` | $D_{Hook, i}$ | 釣り上げ動作時間 | `魚種マスタ.csv` | フッキング演出から次動作可能までの拘束秒数 |

**データソース**: `src/data/logic_master.json`

---

## 8. 計算フロー概要

```
[ユーザー入力]
    ↓
[シナリオID生成] (scenario.js)
    ↓
[シナリオ発生確率計算] (P_Scenario)
    ↓
[重み補正適用] (M_Nx)
    ↓
[ヒット率計算] (P_Hit)
    ↓
[時間計算] (T_Cycle, E[Time])
    ↓
[結果表示]
```

---

## 9. 重要な注意事項

### 計算の前提条件

1. **出現判定**: 重み $w = 0$ の魚種は抽選テーブルから物理的に除外される
2. **隠し魚**: 未発見状態では重み $w = 0$ とし、分母に含めない
3. **効果の揮発性**: ルアー効果は1サイクル終了時にリセットされる（詳細は `rules_and_mechanics.md` 参照）

### データの正本

- **計算式の根拠**: `docs/reference/Game_Domain_Spec.md`
- **実装詳細**: `docs/specs/Logic_Core.md`
- **マスターデータ**: `src/data/logic_master.json`

---

## CHANGELOG

- **2026-02-04**: 初版作成（AI引き継ぎ問題の解決のため、Game_Domain_Spec.md と Logic_Core.md から抽出）
