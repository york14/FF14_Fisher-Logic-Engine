# トラブルシューティング: シェア機能（Share Mode）の不具合修正

**発生日**: 2026-02-03
**担当**: Antigravity
**関連ファイル**: `src/main.js`, `share.html`, `src/style.css`, `scripts/debug_share_encoding.cjs`

## 概要
シェア機能 (`share.html`) において、以下の複数の問題が発生し、段階的に修正を行いました。

1.  **URLデコードエラー ("URI malformed")**
2.  **変数モード (Variable Mode) のロジック不備**
3.  **UIレイアウトの欠落とデザイン崩れ**

また、修正作業中に**自動化ツールからのGit操作が不能になる**という環境問題が発生しました。これについても記録します。

---

## 1. URLデコードエラー ("URI malformed")

### 症状
*   発行されたシェアURLを開くと、「データの読み込みに失敗しました (URI malformed)」というエラーが表示される。
*   または、デコード結果が不正 ("Invalid Data") となる。

### 原因
*   **原因A (プログラム)**: `main.js` のデコード処理 (`decodeURIComponent(escape(atob(...)))`) において、Base64文字列に含まれる特定のバイト列（日本語UTF-8シーケンスなど）が、ブラウザ/Node.js環境によって解釈不一致を起こしていた懸念があった。
*   **原因B (人為的)**: 開発中の手動テストURL生成時に、JSON文字列を手で編集するなどして、Base64エンコードデータが破損していた（ビットシフト等の整合性が取れていなかった）。

### 解決策
*   **デバッグスクリプトの作成**: `scripts/debug_share_encoding.cjs` を作成し、Node.js環境でブラウザと全く同じデコード処理をシミュレートして検証。
*   **正規URLの再発行**: 同スクリプトを使用して、正しい手順でエンコードされたURLを生成し直し、ユーザーに提供したところ解決した。
*   **プログラム修正**: `main.js` の初期化処理 (`initShareMode`) に詳細なエラーログ出力を追加し、原因特定を容易にした。

---

## 2. 変数モード (Variable Mode) のロジック不備

### 症状
*   シェア画面で「変数モード（基礎重み不明）」の結果が表示されない。
*   `ReferenceError: document is not defined` 等のエラーで止まる。

### 原因
*   シェアモードのレンダリング処理 (`renderShareManual` / `initShareMode`) が、`isVariableMode` フラグを考慮していなかった。
*   変数モードの計算ロジック (`runManualModeVariable`) が、`document.getElementById` を多用しており、DOM要素が存在しないシェア画面（`share.html`）では動作しなかった。

### 解決策
*   **URLへのフラグ追加**: `serializeStateToURL` (URL生成関数) に `isVariableMode` を含めるよう修正。
*   **関数改修**: `runManualModeVariable` を修正し、DOMから値を取るのではなく、渡された `config` オブジェクトから値を読み取る「シェアモード対応（DOMレス）」ロジックを追加した。

---

## 3. UIレイアウトの欠落とデザイン崩れ

### 症状
*   **デザイン崩れ**: 背景が白く、文字が見えにくい。CSS変数が効いていない。
*   **情報不足**: 「共通設定（エリアや釣り場名）」が表示されず、結果だけポツンと表示される。
*   **空欄表示**: 「共通設定」の枠を追加しても、中身が空っぽ（Loading...）になる。

### 原因
*   **CSS変数名の定義ミス**: `share.html` で使用していた変数名（`--bg-main` 等）が、`style.css` での定義（`--bg-dark` 等）と食い違っていた。
*   **HTML構造の差異**: `share.html` が簡易的な作りになっており、本体 (`index.html`) のような3カラム構成（左パネルの設定表示）がなかった。
*   **データ不足**: シェアURLには「釣り場名」しか含まれておらず、「拡張名」や「エリア名」が含まれていなかったため、設定欄を埋めることができなかった。

### 解決策
*   **CSS修正**: `share.html` と `style.css` の変数名を統一。
*   **レイアウト移植**: `index.html` の左パネル構造を `share.html` に移植し、`disabled` (読み取り専用) 属性を付与。
*   **データ補完ロジック**: `main.js` の初期化処理 (`initShareMode`) に、「釣り場名からマスターデータを逆引きして、拡張・エリア名を自動入力する」ロジックを追加。

---

## 4. 自動化ツールのGit操作不能問題 (解決済み)

### 症状
*   Agent環境から `git status`, `git commit` 等のコマンドを実行しても、一切の出力がなくハングアップする。

### 原因
*   **ページャー (Pager) の待機**: Gitは出力が長い場合（または環境によって）、自動的に `less` などのページャーを起動し、キー入力（`q`）を待つ挙動となる。
*   Agentの非対話シェル環境では、このキー入力を送れないため、プロセスが無限に待機状態（ハング）になっていた。
*   認証プロンプトだと思われたが、実際には単なる表示待機だった。

### 解決策
*   **`--no-pager` オプションの付与**: 全てのGitコマンドに `git --no-pager <command>` を付けることで、ページャーを無効化し、標準出力に強制的に書き出させるようにした。
*   **検証**: この対応により、Agentからの `git add`, `git commit`, `git push` が正常に動作することを確認済み。

---

## 今後の対策
*   AgentがGit操作を行う際は、必ず `cmd /c git --no-pager ...` の形式で実行する。
*   コミットメッセージは `git commit -F <file>` 形式を使用し、引数エスケープ問題を回避する。

---

## 今後の対策
*   シェア機能のような「ステートレス」な画面を実装する際は、DOM依存（`document.getElementById`）を避け、純粋な `config` オブジェクトを受け取って描画する設計を徹底する。
*   URL生成などのエンコード処理は、必ずスクリプトで自動生成し、手動編集を行わない。
*   **Git操作**: 自動化ツールからのGit操作が不安定な場合、無理に解決しようとせず、早めにユーザーへ手動実行を依頼するフローに切り替える（確実性を優先する）。
