# 論理仕様書: GP管理 v2.1
更新日: 2026-02-04

本書は、GP (Gathering Points) の管理、コスト計算、およびシミュレーションにおける回復ロジックを定義する。
実装対象: `src/core/gp_logic.js` (新規作成推奨)

## 1. GP基本仕様 (Basic Constants)

### 1.1 パラメータ
*   **Max GP (最大GP)**: `1000`
*   **Initial GP (開始時GP)**: `1000` (シミュレーション初期値)

### 1.2 自然回復 (Regeneration)
GPは時間経過により自動的に回復する。
*   **回復量**: `8` GP / Tick
*   **Tick間隔**: `3.0` 秒
*   **実装モデル (Plan B)**: 簡易切り捨て計算を採用。
    *   位相ズレ（サーバータイム00秒同期）は無視する。
    *   計算式: `floor(CycleTime / 3.0) * 8`

## 2. スキルコスト仕様 (Skill Costs)

### 2.1 キャスト前使用 (Pre-Cast Phase)
キャスト動作 (`D_CAST`) の前に使用・消費されるスキル。

| スキル名 | 消費GP | 挙動・備考 |
| :--- | :--- | :--- |
| **撒き餌** (Chum) | **100** | 設定ONの場合、毎キャストの直前に消費。 |
| **トレードリリース** (Surface Slap) | **200** | **「魚を釣り上げる」まで永続**。<br>通常設定では効果付与済なら消費しない。<br>「外道も釣り上げる」設定ONの場合は毎キャスト消費となる。 |
| **セイムキャスト** (Identical Cast) | 350 | (参考) 今回のシミュレーションでは使用しない。 |
| **大物狙い** (Prize Catch) | 200 | (参考) 今回のシミュレーションでは使用しない。 |

### 2.2 キャスト中アクション (Mid-Cast Phase)
キャスティング中（ラインが水中にある状態）に使用するスキル。
※消費GPによるコスト増と、ルアー効果による時間変化（Core Logic計算）のトレードオフが発生する。

| スキル名 | 消費GP | 挙動・プログレッシブコスト |
| :--- | :--- | :--- |
| **アンビシャスルアー**<br>(Ambitious Lure) | **10 / 20 / 30** | 1キャスト中に最大3回まで使用可能。<br>- 1回目: **10** GP<br>- 2回目: **20** GP<br>- 3回目: **30** GP<br>合計最大 **60** GP。<br>次のキャストではリセットされ **10** から開始。 |
| **モデストルアー**<br>(Modest Lure) | **10 / 20 / 30** | 同上。（アンビシャスルアーと別カウントだがコスト体系は同一） |

### 2.3 回復スキル (Recovery Skills)
GPを消費ではなく回復する特殊スキル。

| スキル名 | 回復量 | 挙動・備考 |
| :--- | :--- | :--- |
| **サリャクの祝福**<br>(Thaliak's Favor) | **+150** | インスタント回復。<br>キャスト前使用。<br>シミュレーションでは「1釣行あたりの使用回数 (0~3回)」を設定値として持つ。<br>※v3.1時点では未実装。仕様のみ定義。 |

## 3. アイテム仕様 (Items)

### 3.1 回復アイテム
*   **ハイコーディアル (Hi-Cordial)**
    *   **効果**: GP `+400` 回復 (ただし Max GP を超えない)
    *   **リキャスト**: `180` 秒
    *   **使用タイミング**: 竿上げ/釣り上げ後、次のキャストの前。
    *   **動作硬直**: `1.0` 秒
        *   使用する場合、サイクル時間に `1.0s` 加算される（その分自然回復の機会も増える）。

## 4. シミュレーション・計算ロジックへの統合

### 4.1 サイクル収支 ($B_{GP}$)
1サイクル（キャスト～終了）ごとのGP増減。

$$ B_{GP} = GP_{Regen} + GP_{Item} - C_{Cycle} $$

*   **$GP_{Regen}$ (自然回復)**:
    $$ \lfloor \frac{T_{Total}}{3.0} \rfloor \times 8 $$
    *   $T_{Total}$: サイクル全所要時間（スキル硬直含む）。

*   **$GP_{Item}$ (アイテム回復)**:
    *   使用条件を満たす場合 `+400`。
    *   判定: `180` 秒リキャストが完了していれば使用可能。
    *   実装簡易化のため「リキャスト完了ごとに即使用」または「GPがX以下になったら使用」の戦略オプションとする。

*   **$C_{Cycle}$ (総消費コスト)**:
    *   撒き餌 (100) + トレードリリース + ルアーアクション合計

### 4.2 枯渇判定と持続可能性
*   **持続可能 (Sustainable)**: $B_{GP} \ge -0.1$
*   **枯渇あり (Unsustainable)**: GPが減少する場合、初期GP(1000)からスタートして何サイクル回せるかを算出。
    *   $N_{Deplete} = 1000 / |B_{GP}|$
