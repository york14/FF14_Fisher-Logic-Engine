# 漁師論理エンジン：総合仕様・設計書 (Integrated Spec & Design) v1.7.3

## 1. プロジェクト概要
FF14（パッチ7.x以降）における漁師のスキル回しを理論的に最適化するための計算基盤である。サーバーサイドの判定挙動（キャスト後の再抽選プロセス）をエミュレートし、実戦に即した期待値および効率スコアを算出する。

## 2. 漁師論理仕様 (Logical Specification)

### 2.1 基本シーケンス (Game Flow)
1キャストにおける一連のプロセス（１セット）を以下の通り定義する。
1. **キャスト前スキル使用**: 撒き餌（Chum）など、待機時間に影響を与えるスキルを使用する。
2. **キャスト実行 (Cast)**: サーバー側で初期のHit対象が決定される。
3. **キャスト後スキル使用 (ルアーアクション)**: ルアーを使用するごとに、現在の判定（発見、型確定、または通常）に基づきHit対象の「再抽選（Re-roll）」が実行され、内部的なHit対象が書き換えられる。
4. **キャストまたはルアーアクション終了後**: 最終的なHit対象が確定し、それに応じた演出（！、！！、！！！）が発生する。
5. **Hit（フッキング～釣り上げ演出）**: フッキングを行い、魚種（震動）に応じた拘束時間を経て１セットが終了する。

### 2.2 スキルによる効果
- **撒き餌 (Chum)**: キャスト後の魚の引きまでの待機時間（BiteTime）を 40% 短縮（0.6倍）させる。
- **ルアーアクション**: 使用回数 $n$ に応じて、対応する型の魚の出現重みを強化する。
    - **型対応**: アンビシャスルアー ＝ 大型 / モデストルアー ＝ 小型
    - **重み倍率**: 1回 ＝ 1.5倍 / 2回 ＝ 2.0倍 / 3回 ＝ 6.0倍
    - **追加効果**: 再抽選プロセスにおいて「隠された魚の発見」および「特定の型の確定」を発生させる。

### 2.3 視覚演出とHit拘束時間
ヒット時に発生する演出（震動）によって、フッキングから釣り上げまでの演出拘束時間が変動する。
- **「！」 (弱震)**: 5.0s
- **「！！」 (強震)**: 10.0s
- **「！！！」 (激震)**: 15.0s

---

## 3. プロジェクト構成とファイル定義 (File Definitions)

本プロジェクトは以下のファイル群で構成され、相互に連携する。

### 3.1 ルートディレクトリ
- **index.html**: 本アプリのエントリーポイント。全てのCSSおよびJSファイルを適切な順序でロードし、シミュレーターと管理窓のUI構造を定義する。

### 3.2 ソースコード層 (src/)
- **src/data/fisherdata.js**: シミュレーターが計算に使用する「正本」データを保持する。CSVから変換された `FISHER_DATA` オブジェクトを格納し、全ての論理モジュールへ数値を提供する。
- **src/logic/engine.js**: 計算エンジンのコア。`fisherdata.js` の数値を参照し、「再抽選モデル」に基づいた確率計算および戦略期待値の算出を行う。
- **src/logic/csv_handler.js**: データ管理ロジック。アップロードされたCSVの解析（JSON変換）および、ブラウザからのデータ出力（JS/CSV形式）を担当する。
- **src/ui/main.js**: UI制御モジュール。タブ切り替え、DOM操作、シミュレーターの初期化、および `engine.js` とUIの橋渡しを行う。
- **src/ui/style.css**: アプリケーションの視覚デザイン定義。

### 3.3 作業・ドキュメント層
- **csv/**: 作業用CSVファイルの保管庫。Excel等で編集するソースファイルを置く。
- **docs/**: プロジェクトの知識基盤（Knowledge-Canon）や本資産ドキュメントを格納する。

---

## 4. 技術仕様 (Technical Specification)

### 4.1 時間定数 (Time Parameters)
| 定数名 | 内容 | 値 |
| :--- | :--- | :--- |
| $D_{Cast}$ | キャスト硬直 | 1.0s |
| $D_{Rest}$ | 竿上げ（中断）硬直 | 1.0s |
| $D_{Lure\_Rigid}$ | ルアーアクション硬直（1回あたり） | 2.5s |
| $D_{Lure\_Blk}$ | ルアー演出に伴う最小空白時間 | 2.5s |
| $D_{Skill\_Chum}$ | 撒き餌使用硬直 | 1.0s |

### 4.2 判定・再抽選パラメータ
ルアー使用時、以下の優先順位で再抽選が実行される。
1. **発見 (Discovery)**: 隠し魚がテーブルに追加され、再抽選で隠し魚が選ばれる真の確率。
2. **確定 (Guaranteed)**: 特定の型に絞り込まれた状態で再抽選が行われる真の確率。
3. **通常 (Normal)**: 特殊判定が発生しない場合、現在のテーブルで再抽選を行う。

---

## 5. 動的確率モデル（再抽選定義）
釣り場、天気/時間、餌、トレードリリース対象の組み合わせごとに定義される「魚テーブル2」の変数群。

### 5.1 発見・確定率の定義
- **発見率 $n$**: $n$ 回目のルアー使用時に隠し魚が発見・再抽選される確率。
- **確定率 $n$**: 発見が発生しなかった $n$ 回目のルアー使用時に、型確定・再抽選が行われる確率。
- **発見 $n$ 確定率 $m$**: $n$ 回目で発見成功後、さらに $m$ 回目の使用で型確定が発生する確率。

### 5.2 隠し魚Hit率（期待値）
- **発見 $n$ 隠しHit率 $m$**: $n$ 回目に発見し、$m$ 回目のアクションまで終えた状態で隠し魚がHit対象として確定している確率。

---

## 6. データ管理ワークフロー (Data Persistence Workflow)
データの永続性を保ち、Git管理を円滑にするための標準手順。

1. **CSV編集**: ローカルの作業用CSVを Excel 等で編集する。
2. **データ反映**: HTML上の「データ管理窓」に CSV をアップロードし、内部データを更新する。同名の釣り場が存在する場合は自動的に上書きされる。
3. **正本出力**: 管理窓から `fisherdata.js` をダウンロード出力する。
4. **ローカル同期**: 出力ファイルをプロジェクトのデータフォルダへ上書き保存する。
5. **Git管理**: 更新された JS ファイルを Git へコミット・プッシュし、正本を更新する。

---

## 7. 計算モデル (Calculation Model)

### 7.1 変数定義
- $T_{Bite}$: 魚固有の引きまでの時間（秒）
- $C_{Chum}$: 撒き餌補正（使用時0.5 / 未使用時1.0）
- $n$: ルアー使用回数
- $D_{Hook}$: 演出時間（！:5s / ！！:9s / ！！！:13s）
- $P_{target}$: ターゲット魚が最終的に選ばれる確率

### 7.2 合計サイクル時間 ($T_{Cycle}$)
$$T_{Cycle} = D_{Skill\_Pre} + D_{Cast} + T_{Final} + D_{Hook}$$
※ $T_{Final}$（実効待機時間） = $\max(T_{Bite} \times C_{Chum}, (n \times D_{Lure\_Rigid}) + D_{Lure\_Blk})$

### 7.3 効率スコア (Efficiency Score)
1. **10分あたりの期待獲得数 ($Yield_{10m}$)**: $P_{target} \times \frac{600}{T_{Cycle}}$
2. **1匹あたりの期待時間 ($T_{Expected\_Catch}$)**: $\frac{T_{Cycle}}{P_{target}}$

---

## 8. 戦略定義 (Strategy Definitions)

### 8.1 戦略3：発見追従・確定終了型 (Discovery-Adaptive)
- **基本目標**: 2スタック。
- **分岐ルール**:
    - **型確定**が発生: 即キャスト（再抽選成功とみなす）。
    - **発見**が発生: 3スタックまで延長（隠し魚のHit率向上を狙う）。
    - いずれも発生せず目標回数に到達: キャスト。