# 漁師論理エンジン：総合仕様・設計書 (Integrated Spec & Design) v1.8.2

## 1. プロジェクト概要
FF14（パッチ7.x以降）における漁師의スキル回しを理論的に最適化するための計算基盤である。サーバーサイドの判定挙動（キャスト後の再抽選プロセス）をエミュレートし、実戦に即した期待値および効率スコアを算出する。

## 2. システムの目的と「やれること」
本システムは、複雑な再抽選アルゴリズムを可視化し、状況に応じた最高効率の釣り方を導き出すことを目的とする。

### 2.1 パラメータの可視化 (未実装)
- 内部で保持している各種スキルの動作時間、効果量、魚テーブル2の「N回目発見率」「N回目確定率」などの設定数値を画面下部またはポップアップで表示する。

### 2.2 メインワークフロー
1.  **環境設定**: 釣り場を選択後、連動して更新される「天気/時間」「釣り餌」「ハズレをスルー（竿上げ）する/全部釣り上げる」「トレードリリース対象」を選択する。
2.  **ターゲット設定**: 目標とする魚を選択する。
3.  **解析実行**: 「テーブル表示」ボタンにより、現在の条件に基づいた魚テーブル（Hiddenを含む全魚種）と、ターゲットの取得効率を表示する。
    - **テーブル表示規則 (未実装)**: 隠れた魚（Hidden）も常に表示するが、未発見時は0%でグレーアウトする。環境設定で重みが0の魚も0%で表示・グレーアウトする。

---

## 3. シミュレーションモードの定義

### 3.1 モードA：手動設定モード
ユーザーが1キャスト内の一連の挙動をすべて指定し、その結果を確認する。
- **設定項目**: 撒き餌の有無、ルアー種類（アンビシャス/モデスト）、ルアー使用回数（0～3回）、各アクション時の状態（発見/確定/なし）。
- **出力結果**: 指定された条件下での最終的な魚テーブル、ターゲットの取得効率2種類。

### 3.2 モードB：戦略選択モード
特定の「釣り方（戦略）」を選択し、その戦略を繰り返した場合の期待値を算出する。
- **設定項目**: 撒き餌の有無、ルアーアクション戦略（例：「必ず3回使う」「必ず2回使う」「基本2回だが発見したら3回」など）。
- **出力結果**: 戦略実行時の平均的な魚テーブル（期待値）、ターゲットの取得効率2種類。

### 3.3 モードC：最適戦略自動計算モード (未実装)
現在の環境条件において、最も効率の良い手順をシステムが自動で算出する。
- **設定項目**: なし（現在の釣り場、天気、釣り餌などの条件から全パターンを走査）。
- **出力結果**: 取得効率で評価した戦略ベスト3の名称、それぞれの魚テーブル、取得効率。

---

## 4. 漁師論理仕様 (Logical Specification)

### 4.1 基本シーケンス (Game Flow)
1キャストにおける一連のプロセス（１セット）を以下の通り定義する。
1. **キャスト前スキル使用**: 撒き餌（Chum）など、待機時間に影響を与えるスキルを使用する。
2. **キャスト実行 (Cast)**: 初期のHit対象が決定される。
3. **キャスト後スキル使用 (ルアーアクション)**: ルアーを使用するごとに、現在の判定（発見、型確定、または通常）に基づきHit対象の「再抽選（Re-roll）」が実行され、内部的なHit対象が書き換えられる。
4. **キャストまたはルアーアクション終了後**: 最終的なHit対象が確定し、それに応じた演出（！、！！、！！！）が発生する。
5. **Hit（フッキング～釣り上げ演出）**: フッキングを行い、魚種（震動）に応じた拘束時間を経て１セットが終了する。

### 4.2 魚種属性の定義
- **型 (Type)**: 大型 (Large-jawed) / 小型 (Small-jawed)。ルアーの再抽選適合性を決定する不変の属性である。
- **ラージサイズ (Large-sized)**: 魚の個体品質（状態）を示すフラグ。ルアーの「型確定」とは独立した要素として扱う。

### 4.3 スキルによる効果
- **撒き餌 (Chum)**: キャスト後の魚の引きまでの待機時間（BiteTime）を 40% 短縮（0.6倍）させる。
- **ルアーアクション**: 使用回数 $n$ に応じて、対応する型の魚の出現重みを強化する。
    - **型対応**: アンビシャスルアー ＝ 大型 / モデストルアー ＝ 小型
    - **重み倍率**: 1回 ＝ 1.5倍 / 2回 ＝ 2.0倍 / 3回 ＝ 6.0倍
    - **追加効果**: 再抽選プロセスにおいて「隠された魚の発見」および「特定の型の確定」を発生させる。

### 4.4 視覚演出とHit拘束時間
ヒット時に発生する演出（震動）によって、フッキングから釣り上げまでの演出拘束時間が変動する。
- **「！」 (弱震)**: 5.0s
- **「！！」 (強震)**: 10.0s
- **「！！！」 (激震)**: 15.0s
- **竿上げ (Rest)**: 2.0s

---

## 5. プロジェクト構成とファイル定義 (File Definitions)

### 5.1 ルートディレクトリ
- **index.html**: 本アプリのエントリーポイント。全てのCSSおよびJSファイルをロードし、UI構造を定義する。

### 5.2 ソースコード層 (src/)
- **src/data/fisherdata.js**: シミュレーターが計算に使用する「正本」データ。CSVから変換された `FISHER_DATA` オブジェクトを格納する。
- **src/logic/engine.js**: 計算エンジンのコア。再抽選モデルに基づいた確率計算および戦略期待値の算出を行う。
- **src/logic/csv_handler.js**: データ管理ロジック。CSVの解析（JSON変換）および、ブラウザからのデータ出力（JS/CSV形式）を担当する。
- **src/ui/main.js**: UI制御モジュール。タブ切り替え、DOM操作、シミュレーターの初期化、およびエンジンとの橋渡しを行う。
- **src/ui/style.css**: アプリケーションの視覚デザイン定義。

---

## 6. 技術仕様 (Technical Specification)

### 6.1 時間定数 (Time Parameters)
| 定数名 | 内容 | 値 |
| :--- | :--- | :--- |
| $D_{Cast}$ | キャスト硬直 | 1.0s |
| $D_{Lure\_Rigid}$ | ルアーアクション硬直（1回あたり） | 2.5s |
| $D_{Lure\_Blk}$ | ルアー演出に伴う最小空白時間 | 2.5s |
| $D_{Skill\_Chum}$ | 撒き餌使用硬直 | 1.0s |
| $D_{Rest}$ | 竿上げ（スルー）硬直 | 2.0s |

### 6.2 判定・再抽選パラメータ
ルアー使用時、以下の優先順位で再抽選が実行される。
1. **発見 (Discovery)**: 隠し魚が追加・再抽選される真の確率。
2. **確定 (Guaranteed)**: 特定の型に絞り込まれた状態で再抽選が行われる真の確率。
3. **通常 (Normal)**: 特殊判定が発生しない場合、現在のテーブルで再抽選を行う。

---

## 7. 計算モデル (Calculation Model)

### 7.1 合計サイクル時間 ($T_{Cycle}$)
$$T_{Cycle} = D_{Skill\_Pre} + D_{Cast} + T_{Final} + D_{Hook}$$
※ $T_{Final}$（実効待機時間） = $\max(T_{Bite} \times C_{Chum}, (n \times D_{Lure\_Rigid}) + D_{Lure\_Blk})$。
※ 「ハズレをスルー（竿上げ）する」設定時は、$D_{Hook}$ は魚種によらず一律「竿上げ(2.0s)」として計算する。

### 7.2 効率スコア (Efficiency Score)
1. **10分あたりの期待獲得数 ($Yield_{10m}$)**: $P_{target} \times \frac{600}{T_{Cycle}}$
2. **1匹あたりの期待時間 ($T_{Expected\_Catch}$)**: $\frac{T_{Cycle}}{P_{target}}$

---

## 8. データ管理ワークフロー (Data Persistence Workflow)
1. **CSV編集**: ローカルの作業用CSVを Excel 等で編集する。
2. **データ反映**: HTML上の「データ管理窓」に CSV をアップロードし、内部データを更新する。
3. **正本出力**: 管理窓から `fisherdata.js` をダウンロード出力する。
4. **ローカル同期**: 出力ファイルをプロジェクトのデータフォルダへ上書き保存する。
5. **Git管理**: 更新された JS ファイルを GitHub へコミット・プッシュし、正本を更新する。

---

## 9. 戦略定義 (Strategy Definitions)

### 9.1 戦略3：発見追従・確定終了型 (Discovery-Adaptive)
- **基本目標**: 2スタック。
- **分岐ルール**:
    - **型確定**が発生: 即キャスト（再抽選成功とみなす）。
    - **発見**が発生: 3スタックまで延長（隠し魚のHit率向上を狙う）。
    - いずれも発生せず目標回数に到達: キャスト。