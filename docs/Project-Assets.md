# 漁師論理エンジン：総合仕様・設計書 (Master Spec) v1.9.4

## 第1章：プロジェクト概要
### 1.1 プロジェクトの目的
FF14（パッチ7.x以降）における漁師のスキル回しを理論的に最適化するための計算基盤である。
サーバー側の判定挙動（キャスト後の再抽選プロセス）をエミュレートし、実効待機時間と演出硬直を含めた真の効率を算出することで、特定のターゲット魚に対する最高効率の戦略を導き出すことを目的とする。

### 1.2 本システムで「やれること」
- **再抽選アルゴリズムの可視化**: ルアー使用による内部的な判定（発見・確定・通常）プロセスのシミュレーション。
- **期待値算出**: 条件（釣り場、天気、釣り餌、トレードリリース）に応じた全魚種の期待確率・効率の算出。
- **戦略比較**: 戦略（ルアー回数、発見時の追従など）による効率の比較と最適解の提示。

---

## 第2章：ドメイン定義（FF14 ゲーム仕様）
ここでは、公式ガイドに基づいた用語定義および動作時間の基礎数値を集約する。

### 2.1 用語定義・日英対訳
| 日本語名 | 英語名 | 説明 |
| :--- | :--- | :--- |
| キャスティング | Cast | 釣りを開始する基本アクション。 |
| 撒き餌 | Chum | 次のキャスト時に、魚のアタリがあるまでの時間を短縮するスキル。 |
| フッキング | Hook | 餌に食いついた魚を針に引っ掛けるアクション。 |
| 釣り餌 | Bait | 釣り場や狙う魚に合わせて選択する消耗品。 |
| トレードリリース | Surface Slap | 直前に釣り上げた魚が出現しなくなるスキル。 |
| アンビシャスルアー | Ambitious Lure | 大型の魚を引き寄せ、かかりやすくするルアーアクション。 |
| モデストルアー | Modest Lure | 小型の魚を引き寄せ、かかりやすくするルアーアクション。 |
| 竿上げ | Rest | 仕掛けを水中から引き上げ、竿を構えた状態にする動作。 |
| 型 | Type | 大型 (Large-jawed) / 小型 (Small-jawed) という不変の属性。 |
| ラージサイズ | Large-sized | 標準サイズよりも大きい個体。型確定とは独立した個体状態。 |
| 隠れた魚 | Rare species / Hidden | 初期状態では出現せず、ルアーアクション等の特定条件下で出現する魚。 |

### 2.2 動作時間・補正値一覧
| カテゴリ | 項目 | 数値 | 内容 |
| :--- | :--- | :--- | :--- |
| スキル効果 | 撒き餌補正 ($C_{Chum}$) | 0.6倍 | 待機時間（BiteTime）を40%短縮する。 |
| 動作硬直 | キャスト硬直 ($D_{Cast}$) | 1.0s | キャスティング開始時の固定硬直。 |
| 動作硬直 | ルアーアクション硬直 | 2.5s | アンビシャス/モデストルアー使用時の硬直。 |
| 動作硬直 | 演出最小空白 | 2.5s | ルアー演出に伴うシステム上の最小猶予時間。 |
| 演出拘束 | 弱震 (「！」) | 5.0s | ヒットから釣り上げ完了までの拘束時間。 |
| 演出拘束 | 強震 (「！！」) | 10.0s | ヒットから釣り上げ完了までの拘束時間。 |
| 演出拘束 | 激震 (「！！！」) | 15.0s | ヒットから釣り上げ完了までの拘束時間。 |
| 演出拘束 | 竿上げ ($D_{Rest}$) | 2.0s | フッキングせずに仕掛けを引き上げた際の拘束時間。 |

---

## 第3章：ロジック定義（計算・戦略アルゴリズム）
### 3.1 計算用変数定義
- $T_{Bite}$: 魚固有の引きまでの時間（秒）。
- $n$: ルアーアクション使用回数（0～3回）。

### 3.2 合計サイクル時間 ($T_{Cycle}$) の算出
$$T_{Cycle} = D_{Skill\_Pre} + D_{Cast} + T_{Final} + D_{Hook}$$
- $T_{Final}$ = $\max(T_{Bite} \times C_{Chum}, (n \times 2.5) + 2.5)$。
- 「ハズレをスルー（竿上げ）する」設定時は、ターゲット以外の魚種において $D_{Hook} = D_{Rest}(2.0s)$ を適用する。

### 3.3 空白時間 (Blank Time) の算出
キャスト動作から最速でフッキングまたは次のアクションが可能になるまでの物理的拘束時間。
$$T_{Blank} = D_{Cast} + (n \times 2.5) + 2.5$$

---

## 第4章：システム定義（構成・UI設計）
### 4.1 ファイル構成と役割
- **index.html**: エントリーポイント。UIレイアウトの定義と、全ての外部JS/CSSの読み込みを担当する。
- **src/data/fisherdata.js**: マスターデータ。CSVから統合された `FISHER_DATA` オブジェクトを保持する。
- **src/logic/engine.js**: 計算エンジンのコア。確率木走査アルゴリズムおよび各モードの期待値算出ロジックを保持する。
- **src/logic/csv_handler.js**: データ変換・入出力管理。JSからCSVへの逆変換、およびCSVからのデータ統合を担当する。
- **src/ui/main.js**: UI制御・イベントハンドリング。DOM操作、セレクトボックスの連動、および解析結果のレンダリングを担当する。

### 4.2 シミュレーションモード
- **モードA：手動設定**: デフォルト。ルアー種類、使用回数、および各回の判定結果（なし/発見/確定）をユーザーが指定し、即座に期待値を計算する。
- **モードB：戦略設定**: プリセットされた戦略アルゴリズム（例：戦略3：発見追従型）に基づき、長期的な期待効率を算出する。
- **モードC：最適戦略提案**: 現在の環境において、期待効率が最大となる戦略の組み合わせ（撒き餌の有無、ルアー回数、分岐ルール）を自動走査し提示する（未実装）。

### 4.3 UIレイアウト・表示規則
- **左カラム（サイドバー）**:
    - 環境設定（折りたたみ可能）：釣り場、天気、釣り餌、ハズレ挙動、トレードリリース対象。
    - 目標・解析設定：解析モード（A/B/C）、ターゲット魚、撒き餌有無。
    - ルアー詳細設定（モードA時）：ルアー種類、使用回数、判定選択（発/確）を1行のインライン行に集約。
- **右メインエリア**:
    - 内部設定値（折りたたみ可能・初期閉）：現在の条件に基づく発見率（1-3回目）および型確定率（1-3回目）を表示。
    - シミュレーション結果：日本語表記。魚種、型、期待確率、待機時間、空白時間、演出を表示。
    - 計算式パネル（折りたたみ可能・初期閉）：周期および空白時間の算出根拠を表示。

---

## 第5章：運用定義（データ管理）
### 5.1 データ同期ワークフロー
1. **CSVエクスポート**: `FISHER_DATA` を「釣り場情報」「魚テーブル2」「再抽選確率」の3つの独立したCSVとして出力しダウンロードする。
2. **データインポート**: 外部で編集したCSVをアップロードし、特定の釣り場データとして統合する。
3. **正本出力**: 統合されたデータを `fisherdata.js` として保存し、プロジェクトのデータディレクトリを更新する。