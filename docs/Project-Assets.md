# 漁師論理エンジン：総合仕様・設計書 (Master Spec) v1.9.2

## 第1章：プロジェクト概要
### 1.1 プロジェクトの目的
FF14（パッチ7.x以降）における漁師のスキル回しを理論的に最適化するための計算基盤である。
サーバー側の判定挙動（キャスト後の再抽選プロセス）をエミュレートし、実戦に即した期待値および効率スコアを算出することで、特定のターゲット魚に対する最高効率の戦略を導き出す。

### 1.2 本システムで「やれること」
- 複雑な再抽選アルゴリズムの可視化。
- 条件（釣り場、天気、釣り餌、トレードリリース）に応じた全魚種の期待値算出。
- 戦略（ルアー回数、発見時の追従など）による効率の比較と最適解の提示。

---

## 第2章：ドメイン定義（FF14 ゲーム仕様）
ここでは、公式ガイドに基づいた用語定義および動作時間の基礎数値を集約する。

### 2.1 用語定義・日英対訳
| 日本語名 | 英語名 | 説明 |
| :--- | :--- | :--- |
| キャスティング | Cast | 釣りを開始する基本アクション。 |
| 撒き餌 | Chum | 次のキャスト時に、魚のアタリがあるまでの時間を短縮するスキル。 |
| フッキング | Hook | 餌に食いついた魚を針に引っ掛けるアクション。 |
| 釣り餌 | Bait | 釣り場や狙う魚に合わせて選択する消耗品。 |
| トレードリリース | Surface Slap | 直前に釣り上げた魚が出現しなくなるスキル。 |
| アンビシャスルアー | Ambitious Lure | 大型の魚を引き寄せ、かかりやすくするルアーアクション。 |
| モデストルアー | Modest Lure | 小型の魚を引き寄せ、かかりやすくするルアーアクション。 |
| 竿上げ | Rest | 仕掛けを水中から引き上げ、竿を構えた状態にする動作。 |
| 中断 | Quit | 漁道具をしまい、採集を終了する動作。 |
| 型 | Type | 大型 (Large-jawed) / 小型 (Small-jawed) という、ルアー適合性を決める不変の属性。 |
| ラージサイズ | Large-sized | 標準サイズよりも大きい個体。型確定とは独立した個体状態。 |
| ノーマルサイズ | Average-sized | 標準的なサイズの個体。 |
| 隠れた魚 | Rare species / Hidden | 初期状態では出現せず、ルアーアクション等の特定条件下で出現する魚。 |

### 2.2 動作時間・補正値一覧
シミュレーションの計算根拠となる時間定数および補正値。

| カテゴリ | 項目 | 数値 | 内容 |
| :--- | :--- | :--- | :--- |
| スキル効果 | 撒き餌補正 ($C_{Chum}$) | 0.6倍 | 待機時間（BiteTime）を40%短縮する。 |
| 動作硬直 | キャスト硬直 ($D_{Cast}$) | 1.0s | キャスティング開始時の固定硬直。 |
| 動作硬直 | ルアーアクション硬直 | 2.5s | アンビシャス/モデストルアー使用時の硬直。 |
| 動作硬直 | 撒き餌使用硬直 | 1.0s | 撒き餌アクション実行時の固定硬直。 |
| 動作硬直 | 演出最小空白 | 2.5s | ルアー演出に伴うシステム上の最小猶予時間。 |
| 演出拘束 | 弱震 (「！」) | 5.0s | ヒットから釣り上げ完了までの拘束時間。 |
| 演出拘束 | 強震 (「！！」) | 10.0s | ヒットから釣り上げ完了までの拘束時間。 |
| 演出拘束 | 激震 (「！！！」) | 15.0s | ヒットから釣り上げ完了までの拘束時間。 |
| 演出拘束 | 竿上げ ($D_{Rest}$) | 2.0s | フッキングせずに仕掛けを引き上げた際の拘束時間。 |

### 2.3 ロジック用語の先行定義
第3章の計算モデルおよびアルゴリズムで使用される概念。

- **再抽選 (Re-roll)**: キャスト後に発生する、内部的なヒット対象の書き換えプロセス。
- **発見 (Discovery)**: 隠れた魚が出現テーブルに追加され、再抽選が行われる状態。
- **確定 (Guaranteed)**: 特定の「型」のみが選ばれるよう、再抽選の範囲が絞り込まれた状態。
- **通常 (Normal)**: 特殊判定を伴わない、現在の比率に基づいた抽選状態。
- **重み倍率 ($M$)**: ルアー使用回数に応じて適用される、特定の「型」への出現率補正。

---

## 第3章：ロジック定義（計算・戦略アルゴリズム）

### 3.1 計算用変数定義
- $T_{Bite}$: 魚固有の引きまでの時間（秒）。
- $C_{Chum}$: 撒き餌補正（0.6）。
- $n$: ルアーアクション使用回数（0～3回）。

### 3.2 合計サイクル時間 ($T_{Cycle}$) の算出
$$T_{Cycle} = D_{Skill\_Pre} + D_{Cast} + T_{Final} + D_{Hook}$$
※ $T_{Final}$ = $\max(T_{Bite} \times C_{Chum}, (n \times 2.5) + 2.5)$
※ 「ハズレをスルー（竿上げ）する」設定時は、$D_{Hook} = D_{Rest}(2.0s)$。

### 3.3 再抽選ロジックの優先順位
1. **発見 (Discovery)**: 確率 $P_{Disc}$ に基づく判定。
2. **確定 (Guaranteed)**: 発見失敗時、確率 $P_{Guar}$ に基づく判定。
3. **通常 (Normal)**: 上記以外。現在の重み（$M$ 適用済）による抽選。

---

## 第4章：システム定義（構成・UI設計）

### 4.1 ファイル構成と役割
- **index.html**: エントリーポイント。
- **src/data/fisherdata.js**: マスターデータ（`FISHER_DATA`）。
- **src/logic/engine.js**: 計算コアロジック。
- **src/logic/csv_handler.js**: データ入出力管理。
- **src/ui/main.js**: UIイベントおよび表示制御。

### 4.2 シミュレーションモード
- **モードA (手動)**: 判定結果を個別に指定してシミュレート。
- **モードB (戦略)**: プリセット戦略（戦略3等）に基づく期待値算出。
- **モードC (自動最適化 - 未実装)**: 最高効率戦略の自動検索。

---

## 第5章：運用定義（データワークフロー）

### 5.1 データ同期手順
1. `csv/` 内のソースを編集。
2. 管理窓からインポート（名称重複時は上書き）。
3. `fisherdata.js` をDLし、`src/data/` を上書き。
4. GitHubへプッシュ。