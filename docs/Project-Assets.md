# 漁師論理エンジン：総合仕様・設計書 (Master Spec) v2.9.0

## 第1章：プロジェクト概要
### 1.1 プロジェクトの目的
FF14（パッチ7.x以降）の漁師におけるスキルワークを精密にエミュレートし、実効待機時間と演出硬直を含めた「真の時間効率」を算出する。これにより、特定のターゲット魚に対する最適解（最高効率の戦略）を論理的に導き出すことを目的とする。

### 1.2 システムの主要機能
- **動的パラメータ・シミュレーション**: 環境データ（釣り場・天気・餌）を基盤とし、スキル介入によってリアルタイムに変動する各魚種のHit率および時間パラメータを精緻にエミュレートする。
- **戦略別獲得効率（Yield）の算出**: 任意のアクション戦略に対し、ターゲットの期待Hit率および時間効率を算出・比較する。
- **最高効率戦略（Optimum Strategy）の自動探索**: 分岐を網羅的に走査し、最高効率となるアクションシーケンスを特定・提示する。

---

## 第2章：基本概念と数学的モデリング

### 2.1 重みによるHit率の決定（基本概念）
本エンジンにおけるすべての抽選の根底には、各魚種に割り当てられた**「重み（Weight）」**に基づく相対確率の概念がある。

#### Hit率の算出式
特定の魚種 $i$ のHit率 $P_i$ は、現在有効な全出現候補の重みの総和に対する、自身の重みの割合として定義される。
$$P_i = \frac{w_i}{\sum_{k=1}^{m} w_k}$$
- $w_i$: 魚種 $i$ の重み。
- $m$: 出現条件（天気・餌）を満たす候補魚の総数。
- **解説**: 各魚種が持つ「アタリやすさ」の比率を計算しており、重みが大きいほどHitしやすくなる。

#### トレードリリース（Surface Slap）の数学的効果
トレードリリースを使用した場合、指定した魚種の重みを 0 とし、抽選対象から完全に除外する。
- $w_{slapped} = 0$
- **解説**: 特定の魚を「釣れない状態」に固定することで分母（重みの総和）を減少させ、相対的にターゲット魚を含む他の魚のHit率を底上げする。

### 2.2 キャストから再抽選へのフロー
本システムは、サーバー内部で発生する「2段階の抽選プロセス」をエミュレートする。

1. **初期抽選 (Initial Draw)**:
   キャストした瞬間に、現在のテーブル（トレードリリース適用後）に基づき、最初のヒット対象が内部的に仮決定される。
2. **スキルによる再抽選 (Re-roll)**:
   キャスト後、フッキングまでの間に「ルアーアクション」を使用することで、初期抽選の結果が一定の確率で上書き（再抽選）される。この際、ルアーの種類に応じて特定の「型」の魚種の重みに**重み補正倍率**が適用され、確率分布が動的に補正される。

---

## 第3章：ドメイン定義（型・スキル・演出）

### 3.1 魚種の型と対応スキルの定義
魚種ごとに「型（小型・大型）」は固定されており、これに基づき使用すべきスキルが決定される。

#### ① 型とルアー・フッキングの対応
| 型 (Type) | 対応ルアーアクション | 対応フッキングアクション |
| :--- | :--- | :--- |
| **小型** | モデストルアー | プレシジョンフッキング |
| **大型** | アンビシャスルアー | ストロングフッキング |

#### ② 震動演出と動作時間の対応
| 震動演出 | 演出記号 | 釣り上げ動作時間 ($D_{Hook}$) | 型 (Type) |
| :--- | :--- | :--- | :--- |
| **弱震** | ！ | 5.0s | 小型 |
| **強震** | ！！ | 10.0s | 大型 |
| **激震** | ！！！ | 15.0s | 小型 または 大型 |

- **激震 (！！！) の補足**: 視覚演出からは「小型」「大型」の判別は不可能だが、内部的にはマスタデータに定義された「型」に従っており、ルアーやフッキングの効果計算もその型に準拠して行われる。
- **注意**: 釣り上げ動作時間は一部の魚やコンテンツではこの通りではない。

### 3.2 特殊状態の定義
- **ラージサイズ (Large-sized)**: 釣り上げた後の魚の個体状態（サイズ）を指す。泳がせ釣りや収集品スコアに影響する要素であるが、**「型（小型・大型）」とは独立した概念**である。Hit率や、キャスト中のルアーアクション判定（確定判定等）には一切影響を与えない。

---

## 第4章：物理計算シミュレーション（時間計算）

### 4.1 物理計算定数と変数
| 定数記号 | 名称 | 数値 | 意味・役割 |
| :--- | :--- | :--- | :--- |
| $D_{Cast}$ | キャスト硬直 | 1.0s | キャスティングアクション開始時の固定硬直。 |
| $D_{Lure}$ | ルアーアクション硬直 | 2.5s | ルアー使用1回あたりのアクション硬直時間。 |
| $D_{Blk}$ | ルアー使用後空白 | 2.5s | ルアー使用後に発生する、魚が絶対にHitしないシステム上の空白時間。 |
| $D_{Chum}$ | 撒き餌使用硬直 | 1.0s | 撒き餌アクション自体の実行硬直。 |
| $D_{Rest}$ | 竿上げ硬直 | 2.0s | フッキングせずに仕掛けを引き上げた（中断）際の拘束時間。 |
| $C_{Chum}$ | 撒き餌短縮補正 | 0.6倍 | 有効時、魚の待機時間（BiteTime）を40%短縮する。 |
| $n$ | ルアーアクション回数 | 0 ～ 3 | キャスト中に行うルアーアクションの合計回数。 |

### 4.2 時間算出式と物理的解釈

#### ① 空白時間 ($T_{Blank}$)
キャストからシステム的に最速で魚がヒット（震動発生）可能になるまでの最短拘束時間。
$$T_{Blank} = D_{Cast} + (n \times D_{Lure}) + D_{Blk}$$
- **解説**: キャスト(1.0s)に加え、ルアー回数分の硬直、さらにルアー演出直後に発生する「魚がヒットしない空白時間(2.5s)」を合計したもの。この時間内は抽選が完了していても演出が発生しない。

#### ② 実効待機時間 ($T_{Final}$)
キャストから実際に魚 $i$ が震動（ヒット）を発生させるまでの経過秒数。
$$T_{Final} = \max(T_{Bite, i} \times C_{Chum}, T_{Blank})$$
- $T_{Bite, i}$: 魚種 $i$ 固有の本来の待機時間。
- **解説**: 魚本来のヒットタイミング（撒き餌短縮後）が物理的な空白時間よりも短い場合、空白時間が終了した瞬間にヒットが発生することを意味する。

#### ③ 合計サイクル時間 ($T_{Cycle}$)
1回の釣りを開始してから、次セットのキャストが可能になるまでの全工程時間。
$$T_{Cycle} = D_{Skill\_Pre} + D_{Cast} + T_{Final} + D_{Hook}$$
- $D_{Skill\_Pre}$: キャスト前に撒き餌を使用する場合は $D_{Chum}$ (1.0s)、未使用なら 0。
- **解説**: 準備 ＋ キャスト ＋ 待機 ＋ 釣り上げ動作（または竿上げ中断 $D_{Rest}$）の総和。

---

## 第5章：ルアー効果のアルゴリズム

ルアーアクションの使用に伴い、初期抽選（キャスト時）の結果は、以下の「ルアー効果状況パターン」のいずれかへと遷移する。

### 5.1 ルアー効果状況パターンの分類
ルアー回数 $n \in [0, 3]$ において、物理的に発生し得る全32通りの論理パターンが存在する。

1. **通常補正状況 (Pattern N)**: 特殊判定（発見・確定）が発生しなかった状態。
2. **発見 (Pattern D)**: 1キャストにつき最大1度。成功すれば隠し魚がリストに追加される。
3. **型確定 (Pattern G)**: 未発見のまま発生した型確定判定。効果はその回のみ有効（揮発性）。
4. **型確定(発見済) (Guaranteed after Discovery)**: すでに発見が成功している状態で発生した型確定判定。

- **ルアー0回 ($n=0$)**: 1パターン。重み補正倍率は 1 となり、特殊判定は行われず初期抽選の結果がそのまま採用される。
- **合計**: **32パターン**。隠し魚が釣れる可能性があるのは、このうち「発見」を含む17パターンである。

### 5.2 判定確率の数学的定義
CSV（発見・確定・隠しHit率.csv）に設定される確率は、各判定の独立判定確率（真の値） $P(D)$ および $P(G)$ である。

#### 1. 重み補正倍率の常時適用
発見・確定の成否に関わらず、アクション回数 $n$ に応じて対象の型の重み $w$ を**重み補正倍率**（$n=1: 1.5$倍, $n=2: 2.0$倍, $n=3: 6.0$倍）で常に強化する。

#### 2. 発見 (Discovery) 判定の見かけの確率
アクション $n$ 回目で「発見」が成功する見かけの確率 $\hat{P}(D_n)$ は、それ以前に発見が起きていないことが条件となる。
- $\hat{P}(D_n) = (1 - \sum_{k=1}^{n-1} \hat{P}(D_k)) \times P(D_n)$

#### 3. 型確定 (Guaranteed) 判定の見かけの確率
「型確定」は「同じアクション回で発見が起こらなかった場合」のみ判定が行われる。
アクション $n$ 回目で「発見がなく、かつ確定が起こる」見かけの確率 $\hat{P}(G_n)$ は以下の通り：
- $\hat{P}(G_n) = (1 - \sum_{k=1}^{n} \hat{P}(D_k)) \times P(G_n)$

### 5.3 魚種別最終Hit率の算出
1. **通常魚**: 重み（重み補正倍率適用後）の比率で分配。「型確定」成功時は不適合な型の重みを 0 とする。
2. **隠れた魚**: 重み計算をバイパスし、発見タイミングと合計回数に基づく直接指定値 $P_{DiscHit}$ を採用する。
   - 型確定に成功し、かつ隠し魚の型がルアーと不一致の場合は 0% とする。残りの確率を通常魚で分配する。

---

## 第6章：データスキーマ詳細定義 (Normalized 4-CSV)
データの識別および結合には「釣り場名」を主キーとして使用する。

### 6.1 魚種マスタ
- **列**: 魚種名, 型, 演出

### 6.2 釣り場定義
- **列**: 釣り場名, 天気 / 時間, 餌, 魚種, 隠し魚名

### 6.3 重み・待機時間
- **列**: 釣り場名, 天気 / 時間, 餌, 魚種名, 重み, 待機時間

### 6.4 発見・確定・隠しHit率
各確率は独立判定確率（真の値）として保持する。
- **列**: 釣り場名, 天気 / 時間, 餌, トレード対象, ルアー種類, 
  - `発見率1` / `発見率2` / `発見率3`: 各回の独立発見確率。
  - `確定率1` / `確定率2` / `確定率3`: 未発見時の各回独立確定確率。
  - `発見1確定率2` / `発見1確定率3` / `発見2確定率3`: 発見済み時の各回独立確定確率。
  - `発見1隠しHit率1` / `発見1隠しHit率2` / `発見1隠しHit率3` / `発見2隠しHit率2` / `発見2隠しHit率3` / `発見3隠しHit率3`: 発見タイミングと合計回数に応じた隠し魚の直接Hit率。