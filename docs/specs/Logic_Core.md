# 論理仕様書: コア計算ロジック

本書は、Fisher Logic Engine (FLE) で使用される中核的な数学モデル、定数、およびアルゴリズムを詳述する。
実装: `src/core/calculator.js`, `src/core/scenario.js`

## 1. 定数定義 (GDS)

Game Duration Standards (GDS) は、計算全体で使用される固定時間値および倍率を定義する。

| 定数名 | 値 | 単位 | 説明 |
| :--- | :--- | :--- | :--- |
| `D_CAST` | **0.0** | sec | キャスティング動作時間 (v3ではサイクル計算から除外)。 |
| `D_LURE` | **2.5** | sec | ルアーアクション1回あたりの消費時間。 |
| `D_BLK` | **2.5** | sec | ルアーアクション終了後の硬直時間（魚がかからない）。 |
| `D_CHUM` | **1.0** | sec | 撒き餌アクションの消費時間。 |
| `D_REST` | **2.0** | sec | 「竿上げ (Quit)」アクションの消費時間。 |
| `C_CHUM` | **0.5** | - | 撒き餌使用時の待機時間短縮倍率。 |
| `M_N1` | **1.5** | - | ルアー1回（型一致）使用時の重み倍率。 |
| `M_N2` | **2.0** | - | ルアー2回（型一致）使用時の重み倍率。 |
| `M_N3` | **6.0** | - | ルアー3回（型一致）使用時の重み倍率。 |

## 2. シナリオ管理

### 2.1 シナリオIDフォーマット
ルアー使用結果（シナリオ）は、以下のフォーマット文字列で一意に識別される。
`n{回数}_d{発見ステップ}_g{型確定ステップ}`

*   **n (Number)**: ルアー総使用回数 (0-3)。
*   **d (Discovery)**: 「発見」が発生したステップ番号 (1-n)。発生なしの場合は 0。
*   **g (Guarantee)**: 「型確定」が発生したステップ番号の列 (例: '12' はステップ1と2)。なしの場合は '0'。

**例**: `n2_d1_g2` = ルアー2回使用。ステップ1で発見、ステップ2で型確定。

### 2.2 発生確率計算
あるシナリオが発生する確率は、各ステップの結果確率を掛け合わせることで算出される。

$$ P_{Scenario} = \prod_{i=1}^{n} P_{Step, i} $$

**ステップ確率 ($P_{Step, i}$)** は状態に依存する:
1.  **発見前**:
    *   Master DB の `disc_rates[i]` および `guar_rates_nodisc[i]` を使用。
    *   結果: 発見 ($P_{Disc}$), 型確定 ($P_{Guar}$), なし。
2.  **発見後**:
    *   `guar_rates_after_disc[d{Found}_g{i}]` を使用。
    *   結果: 型確定 ($P_{GuarAfter}$), なし。（発見は2回発生しない）

## 3. 重みとヒット率の計算

### 3.1 重み補正
釣り場の各魚について、基礎重み ($W_{base}$) に現在の状態による倍率補正を行う。

$$ W_{final} = W_{base} \times M $$

**倍率 ($M$) 決定ロジック**:
1.  **Surface Slap (トレードリリース)**: 対象魚の場合、$M = 0$。
2.  **Lure Match (ルアー一致)**: ルアー有効 かつ 型(Jaws)が一致する場合:
    *   $M = M_{Nx}$ (回数に応じて 1.5, 2.0, 6.0)。
3.  **Lure Mismatch (ルアー不一致)**: ルアー有効 かつ 型が一致しない場合:
    *   直近のステップ ($g_{last} \eq n$) で「型確定」している場合: $M = 0$。
    *   それ以外: $M = 1.0$ (変化なし)。
4.  **Hidden Fish (隠し魚)**: 別途処理 (3.2参照)。

### 3.2 ヒット率 ($P_{Hit}$)
特定の魚 $i$ がフッキングされる確率。

1.  **隠し魚**:
    *   確率 ($P_{Hidden}$) は、シナリオIDを用いて `hidden_hit_rates` マップから直接取得する。
    *   未発見シナリオ ($d=0$) の場合、$P_{Hidden} = 0$。
2.  **通常魚**:
    *   残りの確率 $(1.0 - P_{Hidden})$ を、最終重みに基づいて分配する。
    
$$ P_{Hit, i} = \frac{W_{final, i}}{\sum W_{final}} \times (1.0 - P_{Hidden}) $$

### 3.3 変数モード (Unknown Weights)
`isVariableMode` が有効な場合:
*   ターゲット魚の重みを、ユーザー指定確率 (`overrideP`) に合うように動的に逆算・調整する。
*   式: $W_{target} = \frac{P_{override} \times \sum W_{others}}{1.0 - P_{override}}$

## 4. 時間計算モデル

### 4.1 構成要素
*   **$T_{Pre}$**: 撒き餌使用時は `D_CHUM` (1.0s)、未使用なら 0。
*   **$T_{Lure}$**: ルアーアニメーション消費時間。
    $$ T_{Lure} = D_{CAST} + (n \times D_{LURE}) + D_{BLK} $$
*   **$T_{Bite}$**: 魚固有の待機時間範囲 ($Min \dots Max$)。
    *   撒き餌あり: $T_{Bite} = T_{Base} \times C_{CHUM}$。
*   **$T_{Hook}$**:
    *   ターゲット/CatchAll対象: `fish.hook_time`
    *   その他 (竿上げ): `D_REST`

### 4.2 平均待機時間 ($T_{WaitAvg}$)
バイトを待つ平均時間。これはルアー拘束時間と魚の待機時間範囲（アタリ分布）の重なりを**積分**して求める。

*   Case 1 (**標準**): $T_{Lure} \le Min$。待機時間は Min/Max の単純平均。
    *   $Avg = (Min + Max) / 2$
*   Case 2 (**固定**): $T_{Lure} \ge Max$。待機時間はルアー時間に固定される。
    *   $Avg = T_{Lure}$
*   Case 3 (**積分**): $Min < T_{Lure} < Max$。
    *   魚は $[Min, Max]$ の間でアタリが発生するが、少なくとも $T_{Lure}$ までは待機させられる。
    *   $Avg \approx \frac{\int_{Min}^{Max} \max(t, T_{Lure}) dt}{Max - Min}$

### 4.3 サイクル総時間
$$ T_{Cycle} = T_{Pre} + D_{CAST} + T_{WaitAvg} + T_{Hook} $$

*   **即竿上げロジック (Quit Recommendation)**:
    *   設定 `isQuit` (未発見時即竿上げ) が有効 かつ シナリオが $d=0$ の場合:
    *   $T_{Cycle} = T_{Pre} + D_{CAST} + (n \times D_{LURE}) + D_{REST}$
    *   ($D_{BLK}$ および待機時間を無視する。ヒット率は 0 となる)

### 4.4 期待時間 ($E[Time]$)
ターゲットを1匹入手するために必要な平均時間の期待値。

$$ E[Time] = \frac{E[Cycle] - (P_{Target} \times T_{Hook, Target})}{P_{Target}} $$

*注: 分子から「成功時のフッキング時間」を減算しているのは、幾何分布に基づく「成功までの試行時間」において、最後の1回（成功回）のコストを含めるかどうかの定義による。本システムでは純粋な「待ち時間コスト」の期待値を算出している。*
