# 漁師論理エンジン：ゲームドメイン定義書 (Game Domain Spec) v3.11.0

## 1. 重み抽選の基本概念とHit率算出仕様
FF14の抽選システムは、各魚種に設定された「重み（Weight）」に基づく相対的な確率決定プロセスに従う。

### 1.1 基本Hit率の算出（未発見時）
特定の魚種 $i$ のHit率 $P_i$ は、現在有効な全出現候補の重みの総和に対する、自身の重みの割合として定義される。
$$P_i = \frac{w_i}{\sum_{k=1}^{m} w_k}$$
- `WEIGHT` ($w_i$): 「重み・待機時間.csv」に定義される各魚種固有の数値。
- **トレードリリース（Surface Slap）**: 使用時、対象魚の重みを 0 とし、抽選分母から除外することで他魚種のHit率を相対的に上昇させる。
- **発見（Discovery）成功時の挙動**: 隠し魚がテーブルに開放された状態。この場合、隠し魚のHit率は直接指定値 $P_{DiscHit}$ が適用され、残りの確率（$1 - P_{DiscHit}$）を上記式に従って通常魚同士で分配する。

---

## 2. 魚種の型（Jaws）と状態（State）の厳密定義
| 用語 | 物理的な分類 | 意味・対応スキル | CSV/Code表記 |
| :--- | :--- | :--- | :--- |
| **small jaws** | 型 (Type) | 小型魚。モデストルアー、プレシジョンフッキングの対象。 | `small jaws` |
| **large jaws** | 型 (Type) | 大型魚。アンビシャスルアー、ストロングフッキングの対象。 | `large jaws` |
| **large-sized** | 状態 (State) | 釣り上げた後のサイズ状態。Hit率計算には関与しない。 | `large-sized` |

---

## 3. 計算用パラメータおよびマスタ変数定義
システム全体で使用する共通の定数・変数定義。プログラム上で直接参照する「Code Key」を正本とする。

### 3.1 システム固定定数 (Fixed Constants)
| Code Key | 記号 | 名称 | 設定値 | 内容・物理的定義 |
| :--- | :--- | :--- | :--- | :--- |
| `D_CAST` | $D_{Cast}$ | キャスト硬直 | 1.0s | キャスト動作の開始硬直。 |
| `D_LURE` | $D_{Lure}$ | ルアー硬直 | 2.5s | ルアーアクション1回あたりの動作硬直。 |
| `D_BLK` | $D_{Blk}$ | ルアー後空白 | 2.5s | ルアー使用後、Hit判定解禁までの最小猶予。 |
| `D_CHUM` | $D_{Chum}$ | 撒き餌硬直 | 1.0s | 撒き餌使用動作の物理硬直。 |
| `D_REST` | $D_{Rest}$ | 竿上げ硬直 | 2.0s | 竿上げ（中断）動作の硬直。 |
| `C_CHUM` | $C_{Chum}$ | 撒き餌補正 | 0.6 | $T_{Bite}$ に乗算する短縮係数。 |
| `M_N1` | $M_{n1}$ | 重み補正1 | 1.5 | ルアー1回時の適合Jawsへの重み倍率。 |
| `M_N2` | $M_{n2}$ | 重み補正2 | 2.0 | ルアー2回時の適合Jawsへの重み倍率。 |
| `M_N3` | $M_{n3}$ | 重み補正3 | 6.0 | ルアー3回時の適合Jawsへの重み倍率。 |

### 3.2 マスタ参照変数 (Master Variables)
| Code Key | 記号 | 名称 | 参照先マスタ | 内容・定義 |
| :--- | :--- | :--- | :--- | :--- |
| `WEIGHT` | $w_i$ | 基礎重み | `重み・待機時間.csv` | 魚種の釣りやすさの相対比率。Hit率計算のベース |
| `T_BITE` | $T_{Bite, i}$ | 基礎待機時間 | `重み・待機時間.csv` | キャストからアタリ発生までの基礎秒数。 |
| `D_HOOK` | $D_{Hook, i}$ | 釣り上げ動作時間 | `魚種マスタ.csv` | フッキング演出から次動作可能までの拘束秒数。 |

---

## 4. 1サイクルのタイムラインとスキル介入仕様
1キャストの開始から、次動作が可能になるまでのフロー定義。

### 4.1 キャストフローと分岐
1. **キャスト前準備 (Pre-Cast)**
   - 動作硬直があるスキルを使用する場合に追加。例：「撒き餌」を使用する場合、`D_CHUM` (1.0s) を消費。
2. **キャスティング (Cast Execution)**
   - `D_CAST` (1.0s) を消費。待機時間のカウント開始。
3. **アタリ待機とスキル介入 (Waiting & Skills)**
   - ルアーアクション実行ごとに `D_LURE` (2.5s) を消費。
   - ルアー種類と魚種の「型」が照合され、`WEIGHT` に重み補正倍率 `M_Nx` が適用される。

   - 計算上のアタリ発生下限（空白時間）は `(n * D_LURE) + D_BLK` となる。
4. **アタリ発生 (Bite Event)**
   - 実効待機時間 $T_{Final}$ 到達時に震動が発生。
5. **終了フェーズ (Finish Phase) ※条件分岐**
   - **パターンA：釣り上げ (Catch)**
     - フッキングアクションを実行。対象魚種固有の `D_HOOK` (変数) を消費して終了。
   - **パターンB：竿上げ/スルー (Rod Lift / Pass)**
     - フッキングせず、中断アクション（竿上げ）を実行。固定の `D_REST` (2.0s) を消費して終了。

### 4.2 時間算出数式
- **実効待機時間 ($T_{Final}$)**:
  $$T_{Final} = \max(T_{Bite, i} \times C_{Chum}, D_{Cast} + (n \times D_{Lure}) + D_{Blk})$$

- **1サイクル合計時間 ($T_{Cycle}$)**:
  終了時の選択に応じ、以下のいずれかとなる。
  - **釣り上げ時**: $T_{Cycle} = D_{Skill\_Pre} + D_{Cast} + T_{Final} + D_{Hook, i}$
  - **竿上げ時**: $T_{Cycle} = D_{Skill\_Pre} + D_{Cast} + T_{Final} + D_{Rest}$

---



## 5. ルアー効果状況パターンの一般化定義
ルアー使用回数 n (0, 1, 2, 3) における全32パターンは、「発見」の発生タイミングを軸に、以下の論理式で一般化定義される。
### 5.1 構成要素とCodeマッピング
- DISC_RATE_t : t回目の独立発見確率 $P(D_t)$
- GUAR_RATE_t : 未発見時のt回目独立型確定確率 $P(G_t)$
- D_i_GUAR_RATE_t : i回目に発見済みの時のt回目独立型確定確率 $P(G_{i \to t})$

### 5.2 パターンの発生確率（見かけの確率）算出式
任意のパターンの発生確率は、各アクション回 t における確率要素 Prob(t) の積で算出される。
$$P(\text{Pattern}) = \prod_{t=1}^{n} Prob(t)$$
**Prob(t) の決定ロジック：**
1. **発見前（t < i または 発見なし）**
   - 確定あり： (1 - DISC_RATE_t) * GUAR_RATE_t
   - 確定なし： (1 - DISC_RATE_t) * (1 - GUAR_RATE_t)
2. **発見の瞬間（t = i）**
   - DISC_RATE_t
3. **発見後（t > i）**
   - 確定あり： D_i_GUAR_RATE_t
   - 確定なし： 1 - D_i_GUAR_RATE_t

### 5.3 パターン名称の日本語定義
32パターンの名称は、以下の要素を連結して生成する。

- **基本名称**: L(n)
- **発見要素**:
  - 発見あり： 発見(i)
- **型確定要素**:
  - 発見前： 型確定(k)
  - 発見後： 型確定(発見済)(k)

**名称生成の例:**
- L3で1回目に発見、3回目に確定： `L3: 発見1, 型確定(発見済)3`
- L2で1回目に確定、2回目に発見： `L2: 型確定1, 発見2`
---

## 6. ヒット率算出および動作時間詳細仕様
マトリクスの各パターン着地時、以下のロジックで最終的な魚種決定を行う。

### 6.1 隠し魚の直接Hit率
発見済み（$i > 0$）のパターンにおいて、隠し魚のHit率は CSV上の `発見i隠しHit率n` を直接適用する。
※型（small/large jaws）確定が重なっており、かつ隠し魚の型とルアーが不一致の場合は 0% とする。

### 6.2 通常魚の相対Hit率
隠し魚当選以外の残確率（$1 - P_{Hidden}$）を、以下の計算式で通常魚に分配する。
$$P_i = \frac{w_i \times M}{\sum (w_k \times M)} \times (1 - P_{Hidden})$$
- $w$: `重み・待機時間.csv` の「重み」列。トレードリリース対象は $w=0$。
- $M$: 補正倍率。適合Jawsなら `M_Nx`、不適合は 1。型確定成功時に不適合なら $M=0$ とする。

### 6.3 震動演出と動作時間の分離
- **震動演出（！/！！/！！！）**: 演出のみを決定し、釣り上げ時間には直接関与しない。
- **釣り上げ動作時間 ($D_{Hook}$)**: 魚種ごとに「魚種マスタ.csv」の値を直接参照する。未定義時は第3章の標準時間を適用する。

---

## 7. CSVデータ連携定義
### 7.1 魚種マスタ
- 列: `魚種`, `型` (small jaws / large jaws), `演出`, `釣り上げ動作時間` ($D_{Hook}$)

### 7.2 釣り場定義
- 列: `釣り場`, `天気 / 時間`, `餌`, `魚種`, `隠し魚名`

### 7.3 重み・待機時間
- 列: `釣り場`, `天気 / 時間`, `餌`, `魚種`, `重み` ($w_i$), `待機時間` ($T_{Bite, i}$)

### 7.4 発見・確定・隠しHit率
- 列: `発見率1~3`, `確定率1~3`, `発見i確定率n`, `発見i隠しHit率n`---

## 6. ヒット率算出および動作時間詳細仕様
### 6.1 隠し魚の直接Hit率
発見済みパターンの隠し魚Hit率は、CSV列 `発見i隠しHit率n` を直接適用。Jaws不適合時は 0% とする。

### 6.2 通常魚の相対Hit率
$$P_i = \frac{w_i \times M}{\sum (w_k \times M)} \times (1 - P_{Hidden})$$
- $M$: 適合Jawsなら `M_Nx`、不適合は 1。型確定成功時に不適合なら $M=0$。

### 6.3 動作時間の参照
- 釣り上げ時、`D_HOOK` は「魚種マスタ.csv」の値を直接参照する。

---

## 7. CSVデータ連携定義
### 7.1 魚種マスタ
- 列: `魚種`, `型`, `演出`, `釣り上げ動作時間` ($D_{Hook}$)

### 7.2 釣り場定義
- 列: `釣り場`, `天気 / 時間`, `餌`, `魚種`, `隠し魚名`

### 7.3 重み・待機時間
- 列: `釣り場`, `天気 / 時間`, `餌`, `魚種`, `重み` ($w_i$), `待機時間` ($T_{Bite, i}$)

### 7.4 発見・確定・隠しHit率
- 列: `発見率1~3`, `確定率1~3`, `発見i確定率n`, `発見i隠しHit率n`