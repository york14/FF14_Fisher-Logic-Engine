# 漁師論理エンジン (FLE) ID体系およびマッピング定義書

## 1. 概要
本ドキュメントは、ルアー使用時の物理的な遷移状態（ルアーシナリオ）と、その結果適用される統計的な隠し魚ヒット率 ($p$) の対応関係を定義する。

## 2. ルアーシナリオ定義 (32パターン)
ID体系: `n[合計回数]_d[発見回]_g[型確定回]`
- 制約1: 同一ステップで $d$ と $g$ は重複しない。
- 制約2: 発見 ($d$) は最大1回。
- 表記例: `n3_d2_g13` (3回使用、1回目型確、2回目発見、3回目型確)

| 分類 | ID | 1回目 | 2回目 | 3回目 |
| :--- | :--- | :---: | :---: | :---: |
| **0回** | n0_d0_g0 | - | - | - |
| **1回** | n1_d0_g0 | なし | - | - |
| | n1_d0_g1 | 型確 | - | - |
| | n1_d1_g0 | 発見 | - | - |
| **2回** | n2_d0_g0 | なし | なし | - |
| | n2_d0_g1 | 型確 | なし | - |
| | n2_d0_g2 | なし | 型確 | - |
| | n2_d0_g12| 型確 | 型確 | - |
| | n2_d1_g0 | 発見 | なし | - |
| | n2_d1_g2 | 発見 | 型確 | - |
| | n2_d2_g0 | なし | 発見 | - |
| | n2_d2_g1 | 型確 | 発見 | - |
| **3回** | n3_d0_g0 | なし | なし | なし |
| | n3_d0_g1 | 型確 | なし | なし |
| | n3_d0_g2 | なし | 型確 | なし |
| | n3_d0_g3 | なし | なし | 型確 |
| | n3_d0_g12| 型確 | 型確 | なし |
| | n3_d0_g13| 型確 | なし | 型確 |
| | n3_d0_g23| なし | 型確 | 型確 |
| | n3_d0_g123|型確 | 型確 | 型確 |
| | n3_d1_g0 | 発見 | なし | なし |
| | n3_d1_g2 | 発見 | 型確 | なし |
| | n3_d1_g3 | 発見 | なし | 型確 |
| | n3_d1_g23| 発見 | 型確 | 型確 |
| | n3_d2_g0 | なし | 発見 | なし |
| | n3_d2_g1 | 型確 | 発見 | なし |
| | n3_d2_g3 | なし | 発見 | 型確 |
| | n3_d2_g13| 型確 | 発見 | 型確 |
| | n3_d3_g0 | なし | なし | 発見 |
| | n3_d3_g1 | 型確 | なし | 発見 |
| | n3_d3_g2 | なし | 型確 | 発見 |
| | n3_d3_g12| 型確 | 型確 | 発見 |

## 3. 隠し魚Hit率へのマッピング
システム内では、確定したシナリオIDから以下のルールに基づき、統計上のヒット率キー ($p$) を抽出する。

### 3.1 ヒット率特定ロジック
- 発見回 $d$、合計回数 $n$、および **「最後の回($n$)に型確定があったか」** の3要素のみを使用し、道中の型確定履歴は集約（ワイルドカード扱い）する。

| 統計用キー ($p$) | 抽出条件 | 該当するシナリオID群 |
| :--- | :--- | :--- |
| **p1_1_no** | d=1, n=1, gに1を含まない | n1_d1_g0 |
| **p1_2_yes**| d=1, n=2, gに2を含む | n2_d1_g2 |
| **p1_2_no** | d=1, n=2, gに2を含まない | n2_d1_g0 |
| **p1_3_yes**| d=1, n=3, gに3を含む | n3_d1_g3, n3_d1_g23 |
| **p1_3_no** | d=1, n=3, gに3を含まない | n3_d1_g0, n3_d1_g2 |
| **p2_2_no** | d=2, n=2, gに2を含まない | n2_d2_g0, n2_d2_g1 |
| **p2_3_yes**| d=2, n=3, gに3を含む | n3_d2_g3, n3_d2_g13 |
| **p2_3_no** | d=2, n=3, gに3を含まない | n3_d2_g0, n3_d2_g1 |
| **p3_3_no** | d=3, n=3, gに3を含まない | n3_d3_g0, n3_d3_g1, n3_d3_g2, n3_d3_g12 |

## 4. 修正方針

### 4.1 main.js
1. `SCENARIO_NAMES` 定数に上記32パターンのIDと日本語名称を登録する。
2. `calculateScenarioStats` 関数において、算出したシナリオIDから `p{d}_{n}_{last_g}` 形式の統計参照用キーを生成するリデューサー処理を追加する。

### 4.2 fle_master_db.json
1. `hidden_hit_rates` の構成は変更せず（9つの $p$ キーを維持）、ルアーシナリオとは独立した「統計テーブル」として扱う。