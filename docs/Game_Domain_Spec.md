# 漁師論理エンジン：ゲームドメイン定義書 (Game Domain Spec) v3.5.0

## 1. 重み抽選の基本概念とHit率算出
FF14の抽選システムは、各魚種に設定された「重み（Weight）」に基づく相対的な確率決定プロセスに従う。

### 1.1 基本Hit率の算出（未発見時）
特定の魚種 $i$ のHit率 $P_i$ は、現在有効な全出現候補の重みの総和に対する、自身の重みの割合として定義される。
$$P_i = \frac{w_i}{\sum_{k=1}^{m} w_k}$$
- `w_i`: 魚種 $i$ の重み（Code Key: `WEIGHT`）。
- **トレードリリース（Surface Slap）**: 対象魚の重みを $0$ とし、分母から除外することで他魚種のHit率を相対的に上昇させる。
- **発見（Discovery）時の例外**: 発見済み状態（Hidden fish追加後）においては、隠し魚のHit率は直接指定値 $P_{DiscHit}$ が適用され、残りの確率を本式に従い通常魚で分配する。

---

## 2. 魚種の型（Jaws）と状態の定義
混同を避けるため、魚の「性質としての型」と「釣果としての状態」を以下の用語で厳密に区別する。

| 用語 | 分類 | 意味 | CSV/Codeでの表記 |
| :--- | :--- | :--- | :--- |
| **small jaws** | 型 (Type) | 小型魚。モデストルアー、プレシジョンフッキングの対象。 | `small jaws` |
| **large jaws** | 型 (Type) | 大型魚。アンビシャスルアー、ストロングフッキングの対象。 | `large jaws` |
| **large-sized** | 状態 (State) | 釣り上げた後のサイズ状態。Hit確率計算には関与しない。 | `large-sized` |

---

## 3. 物理定数および計算用マッピング
システム全体で使用する物理定数定義。

| Code Key | 記号 | 名称 | 設定値 | 内容・物理的定義 |
| :--- | :--- | :--- | :--- | :--- |
| `D_CAST` | $D_{Cast}$ | キャスト硬直 | 1.0s | キャスト動作自体の物理拘束。 |
| `D_LURE` | $D_{Lure}$ | ルアー硬直 | 2.5s | ルアーアクション1回あたりの動作硬直。 |
| `D_BLK` | $D_{Blk}$ | ルアー後空白 | 2.5s | アクション使用後、Hit判定が解禁されるまでの最小猶予。 |
| `D_CHUM` | $D_{Chum}$ | 撒き餌硬直 | 1.0s | 撒き餌動作の硬直。 |
| `D_REST` | $D_{Rest}$ | 竿上げ硬直 | 2.0s | ヒット前の竿上げ（中断）動作の硬直。 |
| `C_CHUM` | $C_{Chum}$ | 撒き餌補正 | 0.6 | $T_{Bite}$ に乗算する短縮係数。 |
| `M_N1` | $M_{n1}$ | 重み補正1 | 1.5 | ルアー1回時の適合型（Jaws）への重み倍率。 |
| `M_N2` | $M_{n2}$ | 重み補正2 | 2.0 | ルアー2回時の適合型（Jaws）への重み倍率。 |
| `M_N3` | $M_{n3}$ | 重み補正3 | 6.0 | ルアー3回時の適合型（Jaws）への重み倍率。 |

---

## 4. 1サイクルのフローと時間シミュレーション
1回のキャスト開始から次のキャスト可能状態になるまでの全工程。

### 4.1 タイムラインとスキル介入
1. **キャスト前 (Pre-Cast)**
   - スキル：撒き餌（`D_CHUM` 発生）。
2. **キャスト (Cast)**
   - 基本拘束（`D_CAST` 発生）。
3. **待機およびスキル介入 (Waiting & Skills)**
   - 最大3回までのルアーアクション実行可能（各 `D_LURE` 発生）。
   - ルアー使用ごとに「空白時間（`D_BLK`）」によるHit封鎖が発生。
4. **アタリ（Bite）**
   - 実効待機時間（$T_{Final}$）経過時に発生。
5. **釣り上げ動作 (Catch)**
   - 魚種ごとの動作時間（$D_{Hook}$）発生。

### 4.2 時間算出式
- **実効待機時間 ($T_{Final}$)**:
  $$T_{Final} = \max(T_{Bite, i} \times C_{Chum}, D_{Cast} + (n \times D_{Lure}) + D_{Blk})$$
- **合計サイクル時間 ($T_{Cycle}$)**:
  $$T_{Cycle} = D_{Skill\_Pre} + D_{Cast} + T_{Final} + D_{Hook}$$

---

## 5. ルアー効果アルゴリズム（全32パターン）
「発見・確定・隠しHit率.csv」のデータを用いた確率分岐。

### 5.1 確率変数のCode / CSVマッピング
- $P(D_n)$: `DISC_RATE_n` → CSV: `発見率1`〜`3`
- $P(G_n)$: `GUAR_RATE_n` → CSV: `確定率1`〜`3`
- $P(G_{i \to n})$: `D_i_GUAR_RATE_n` → CSV: `発見1確定率2`〜`2確定率3`
- $P_{DiscHit}(i, n)$: `D_i_HIDDEN_HIT_n` → CSV: `発見1隠しHit率1`〜`3隠しHit率3`

### 5.2 判定の優先順位
1. **発見 (Discovery)**: 1キャスト1回。成功で隠し魚開放。
2. **型確定 (Guaranteed)**: 同ターンに発見がない場合のみ判定。適合するJaws以外の重みを0にする。

---

## 6. CSVデータ連携定義

### 6.1 魚種マスタ (Fish Master)
- **列**: `魚種`, `型` (small jaws / large jaws), `演出` (！/！！/！！！)

### 6.2 釣り場定義 (Spot Definition)
- **列**: `釣り場`, `天気 / 時間`, `餌`, `魚種`, `隠し魚名`

### 6.3 重み・待機時間 (Weights & Times)
- **列**: `釣り場`, `天気 / 時間`, `餌`, `魚種`, `重み` ($w_i$), `待機時間` ($T_{Bite, i}$)

### 6.4 発見・確定・隠しHit率 (Discovery & Rates)
- **列**: `発見率x`, `確定率x`, `発見i確定率n`, `発見i隠しHit率n`