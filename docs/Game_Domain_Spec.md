# 漁師論理エンジン：ゲームドメイン定義書 (Game Domain Spec) v3.14.0

## 1. 釣り場の構成と出現の論理階層
FF14における釣りの抽選論理は、以下の3つの階層構造によって決定される。

### 1.1 魚種の固有属性（静的データ）
各魚種が持つ以下の属性は、釣り場や環境に依存せず、常に不変である。
- **型 (Jaws)**: `小型(small jaws)` / `大型(large jaws)` の分類。
- **釣り上げ動作時間 ($D_{Hook}$)**: 釣り上げる際の物理的な拘束時間。

### 1.2 釣り場と出現候補
各「釣り場」には出現し得る魚種のリストが登録されている。ただし、実際に抽選テーブルに乗るかどうかは、後述の動的条件によって決定される。

### 1.3 出現条件と動的パラメータ（動的データ）
以下の要素の組み合わせにより、そのキャストにおける各魚種の「基礎重み ($w_i$)」および「基礎待機時間 ($T_{Bite, i}$)」が決定される。
- **餌 (Bait)**
- **時間・天気条件 (Time / Weather)**
- **発見の有無 (Discovery status)**
- **直感の有無 (Intuition status)** ※注：本ツールでは直感の計算は行わないが、論理定義として保持する。

### 1.4 出現判定とライフサイクルの基本原則
本システムの計算および状態管理における根本的なルール。

#### 1.4.1 出現の判定（重み 0 の定義）
特定の条件（特定の天気、あるいは発見・直感等）を満たしていない魚種は、その時点の重みが $0$ となり、抽選テーブルから物理的に除外される。

#### 1.4.2 効果の有効期間と揮発性（リセットタイミング）
ルアーアクションやスキルによって発生した特殊状態（発見、型確定、重み補正、撒き餌等）は、原則として**1回のアクションサイクル（キャスト）内でのみ有効**である。詳細なリセット条件およびスキルの持続仕様については、**「4.4 スキル・状態の持続・リセット詳細」**を参照すること。

---

## 2. 重み抽選の基本概念とヒット率算出仕様
### 2.1 基本ヒット率の算出（未発見時）
特定の釣り場と条件下での、特定の魚種 $i$ のヒット率 $P_i$ は、現在有効な全出現候補（重み $w > 0$ の魚種）の重みの総和に対する、自身の重みの割合として定義される。
$$P_i = \frac{w_i}{\sum_{k=1}^{m} w_k}$$
- `WEIGHT` ($w_i$): `重み・待機時間.csv` に定義される各魚種固有の数値。
- **トレードリリース (Surface Slap)**: 使用時、対象魚の重みを $0$ とする。
- **発見 (Discovery) 成功時の挙動**: 隠し魚が出現された状態。隠し魚のヒット率は直接指定値 $P_{DiscHit}$ が適用され（第7章参照）、残りの確率を通常魚同士で分配する。

## 3. 魚種の型（Jaws）と状態（State）の厳密定義
| 用語 | 物理的な分類 | 意味・対応スキル | Code表記 |
| :--- | :--- | :--- | :--- |
| **小型** | 型 (Type) | 小型魚。モデストルアー、プレシジョンフッキングの対象。 | `small jaws` |
| **大型** | 型 (Type) | 大型魚。アンビシャスルアー、ストロングフッキングの対象。 | `large jaws` |
| **ラージサイズ** | 状態 (State) | 釣り上げた後のサイズ状態。ヒット率計算には関与しない。 | `large-sized` |

---

## 4. 計算用パラメータおよびマスタ変数定義

### 4.1 システム固定定数 (Fixed Constants)
| Code Key | 記号 | 名称 | 設定値 | 内容・物理的定義 |
| :--- | :--- | :--- | :--- | :--- |
| `D_CAST` | $D_{Cast}$ | キャスト硬直 | 1.0s | キャスト動作の開始硬直。 |
| `D_LURE` | $D_{Lure}$ | ルアー硬直 | 2.5s | ルアーアクション1回あたりの動作硬直。 |
| `D_BLK` | $D_{Blk}$ | ルアー後空白 | 2.5s | ルアー使用後、ヒット判定解禁までの最小猶予。 |
| `D_CHUM` | $D_{Chum}$ | 撒き餌硬直 | 1.0s | 撒き餌使用動作の物理硬直。 |
| `D_REST` | $D_{Rest}$ | 竿上げ硬直 | 2.0s | 竿上げ（中断）動作の硬直。 |
| `C_CHUM` | $C_{Chum}$ | 撒き餌補正 | 0.6 | $T_{Bite}$ に乗算する短縮係数。 |
| `M_N1` | $M_{n1}$ | 重み補正1 | 1.5 | ルアー1回時の適合型への重み倍率。 |
| `M_N2` | $M_{n2}$ | 重み補正2 | 2.0 | ルアー2回時の適合型への重み倍率。 |
| `M_N3` | $M_{n3}$ | 重み補正3 | 6.0 | ルアー3回時の適合型への重み倍率。 |

### 4.2 マスタ参照変数 (Master Variables)
| Code Key | 記号 | 名称 | 参照先マスタ | 内容・定義 |
| :--- | :--- | :--- | :--- | :--- |
| `WEIGHT` | $w_i$ | 基礎重み | `重み・待機時間.csv` | 魚種の釣りやすさの相対比率。ヒット率計算のベース |
| `T_BITE` | $T_{Bite, i}$ | 基礎待機時間 | `重み・待機時間.csv` | キャストからアタリ発生までの基礎秒数。 |
| `D_HOOK` | $D_{Hook, i}$ | 釣り上げ動作時間 | `魚種マスタ.csv` | フッキング演出から次動作可能までの拘束秒数。 |

### 4.3 アクション・スキル効果定義 (Action Effects)
| アクション名 | 実行タイミング | 影響を受ける変数・論理 | 詳細仕様 |
| :--- | :--- | :--- | :--- |
| **キャスト** | サイクル開始 | `D_CAST` | 1サイクルの起点。 |
| **撒き餌** | キャスト前 | `C_CHUM` | ヒット時間を 0.6倍にする。 |
| **ルアー** | 待機中 | `M_Nx` / `DISC` / `GUAR` | 重み補正・発見・確定判定。 |
| **トレードリリース** | キャスト前 | `WEIGHT = 0` | 特定魚種を除外。 |
| **フッキング** | アタリ発生時 | `D_HOOK` | 魚を釣り上げ、サイクルを終了する。 |
| **竿上げ (Rod Lift)** | アタリ発生時 | `D_REST` |サイクルを中断し、終了する。 |

### 4.4 スキル・状態の持続・リセット詳細
各スキルおよび特殊状態の終了条件は以下の通り定義される。本表を状態管理ロジックの正本とする。

| 状態・スキル | リセット・終了のタイミング | 特記事項 |
| :--- | :--- | :--- |
| **発見・型確定** | 1サイクル終了時 (釣り上げ動作/竿上げ動作終了後) | 前回の硬直終了時に消滅する。 |
| **重み補正 ($M_{Nx}$)** | 1サイクル終了時 (釣り上げ動作/竿上げ動作終了後) | サイクルを跨いで引き継がれない。 |
| **撒き餌** | 1サイクル終了時 (釣り上げ動作/竿上げ動作終了後) | 竿上げやアタリ無視でも効果は消失する。 |
| **トレードリリース** | **魚を釣り上げた(Catch)瞬間** | **竿上げ(Rod Lift)では終了せず、次サイクルに継続する。** |

#### 時間制限の定義
撒き餌、ルアー、トレードリリースには、**バフとしての時間制限は存在しない**。一度付与された効果は、上記の終了条件を満たすまで永続する。

---

## 5. 1サイクルのタイムラインとスキル介入仕様
### 5.1 キャストフローと分岐
1. **キャスト前準備 (Pre-Cast)**
   - 動作硬直があるスキルを使用する場合に追加。例：「撒き餌」を使用する場合、`D_CHUM` (1.0s) を消費。
2. **キャスティング (Cast Execution)**
   - `D_CAST` (1.0s) を消費。待機時間のカウント開始。
3. **アタリ待機とスキル介入 (Waiting & Skills)**
   - ルアーアクション実行ごとに `D_LURE` (2.5s) を消費。
   - ルアー種類と魚種の「型」が照合され、`WEIGHT` に重み補正倍率 `M_Nx` が適用される。
   - 計算上のアタリ発生下限（空白時間）は `(n * D_LURE) + D_BLK` となる。
4. **アタリ発生 (Bite Event)**
   - 実効待機時間 $T_{Final}$ 到達時に震動が発生。
5. **終了フェーズ (Finish Phase) ※条件分岐**　終了後、各状態のリセット条件は「4.4」の表に従う。
   - **パターンA：釣り上げ (Catch)**
     - `D_HOOK` を消費。
   - **パターンB：竿上げ (Rod Lift)**
     - `D_REST` を消費。
### 5.2 時間算出数式
- **実効待機時間 ($T_{Final}$)**:
  $$T_{Final} = \max(T_{Bite, i} \times C_{Chum}, D_{Cast} + (n \times D_{Lure}) + D_{Blk})$$

- **1サイクル合計時間 ($T_{Cycle}$)**:
  終了時の選択に応じ、以下のいずれかとなる。
  - **釣り上げ時**: $T_{Cycle} = D_{Skill\_Pre} + D_{Cast} + T_{Final} + D_{Hook, i}$
  - **竿上げ時**: $T_{Cycle} = D_{Skill\_Pre} + D_{Cast} + T_{Final} + D_{Rest}$



---

## 6. ルアー効果状況パターンの一般化定義
ルアー使用回数 n (0, 1, 2, 3) における全32パターンは、「発見」の発生タイミングを軸に、以下の論理式で一般化定義される。
### 6.1 構成要素とCodeマッピング
- DISC_RATE_t : t回目の独立発見確率 $P(D_t)$
- GUAR_RATE_t : 未発見時のt回目独立型確定確率 $P(G_t)$
- D_i_GUAR_RATE_t : i回目に発見済みの時のt回目独立型確定確率 $P(G_{i \to t})$

### 6.2 パターンの発生確率（見かけの確率）算出式
任意のパターンの発生確率は、各アクション回 t における確率要素 Prob(t) の積で算出される。
$$P(\text{Pattern}) = \prod_{t=1}^{n} Prob(t)$$
**Prob(t) の決定ロジック：**
1. **発見前（t < i または 発見なし）**
   - 型確定あり： (1 - DISC_RATE_t) * GUAR_RATE_t
   - 型確定なし： (1 - DISC_RATE_t) * (1 - GUAR_RATE_t)
2. **発見の瞬間（t = i）**
   - DISC_RATE_t
3. **発見後（t > i）**
   - 型確定あり： D_i_GUAR_RATE_t
   - 型確定なし： 1 - D_i_GUAR_RATE_t

### 6.3 パターン名称の日本語定義
32パターンの名称は、以下の要素を連結して生成する。

- **基本名称**: L(n)
- **発見要素**:
  - 発見あり： 発見(i)
- **型確定要素**:
  - 発見前： 型確定(k)
  - 発見後： 型確定(発見済)(k)

**名称生成の例:**
- L3で1回目に発見、2回目は何も発生せず、3回目に型確定： `L3: 発見1, 型確定(発見済)3`
- L2で1回目に型確定、2回目に発見： `L2: 型確定1, 発見2`
---

## 7. ヒット率算出および動作時間詳細仕様
マトリクスの各パターン着地時、以下のロジックで最終的な魚種決定を行う。

### 7.1 隠し魚の直接ヒット率
発見済み（$i > 0$）のパターンにおいて、隠し魚のヒット率は CSV上の `発見i隠しヒット率n` を直接適用する。
※型確定が重なっており、かつ隠し魚の型とルアーが不一致の場合は 0% とする。

### 7.2 通常魚の相対ヒット率
隠し魚当選以外の残確率（$1 - P_{Hidden}$）を、以下の計算式で通常魚に分配する。
$$P_i = \frac{w_i \times M}{\sum (w_k \times M)} \times (1 - P_{Hidden})$$
- $w$: `重み・待機時間.csv` の「重み」列。トレードリリース対象は $w=0$。
- $M$: 補正倍率。適合型なら `M_Nx`、不適合は 1。型確定成功時に不適合なら $M=0$ とする。

### 7.3 震動演出と動作時間の分離
- **震動演出（！/！！/！！！）**: 演出のみを決定し、釣り上げ時間には直接関与しない。
- **釣り上げ動作時間 ($D_{Hook}$)**: 魚種ごとに「魚種マスタ.csv」の値を直接参照する。

---

## 8. CSVデータ連携定義
### 8.1 魚種マスタ
- 列: `魚種`, `型` (小型 / 大型), `演出`, `釣り上げ動作時間` ($D_{Hook}$)

### 8.2 釣り場定義
- 列: `釣り場`, `天気 / 時間`, `餌`, `魚種`, `隠し魚名`

### 8.3 重み・待機時間
- 列: `釣り場`, `天気 / 時間`, `餌`, `魚種`, `重み` ($w_i$), `待機時間` ($T_{Bite, i}$)

### 8.4 発見・型確定・隠しヒット率
- 列: `発見率1~3`, `型確定率1~3`, `発見i型確定率n`, `発見i隠しヒット率n`