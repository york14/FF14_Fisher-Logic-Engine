# Fisherman Logic Engine (FLE) - System Spec v1.2

## 第1章：確定済み事項 (Confirmed Specifications)

### 1.1 マスターデータと変換基盤 (Master Data & Converter)
- **管理ツール**: `FLE Master Converter v1.1` (ブラウザベース) を使用。
- **データ形式**: 4つのCSVを統合した単一の `fle_master_db.json` を正本とする。
- **データ正規化ルール**:
    - **確率値**: `23.11%` → `0.2311` (Float)
    - **型表記**: `小型` → `small_jaws`, `大型` → `large_jaws`
    - **演出記号**: 全角 `！` は半角 `!` に統一。
    - **論理値**: `0/1` は `false/true` に変換。
- **データ欠損（空白）の厳密管理**:
    - 「発見・型確定・隠しヒット率」において、CSVの空白セルは `null` として保持する。
    - 数値 `0`（0.00%）とは明確に区別し、シミュレーション時の判定に使用する。

### 1.2 統合JSONデータ構造 (JSON Schema)
```json
{
  "version": "1.1.0",
  "fish": { "魚種名": { "type": "small_jaws", "can_slap": true, ... } },
  "spots": { "釣り場名": { "weather": [], "bait": [], "fish": [] } },
  "weights": { "Spot|Weather|Bait": [{ "name": "...", "w": 200, "t": 15 }] },
  "probabilities": {
    "Spot|Weather|Bait|Hidden|Slap|Lure": {
      "discovery": [0.2311, null, null],
      "guarantee": [0.0328, null, null],
      "discovered_guarantee": [null, 0.1021, 0.2153],
      "hidden_hit_rates": { "p1_1_no": 0.1628, ... }
    }
  }
}

```

## 第2章：機能要件と計算ロジック (Functional Requirements)

### 2.1 ユーザー入力とシミュレーション条件
- **環境設定**: 釣り場、天気、餌。
- **スキル設定**: 
    - 撒き餌 (Chum): ON/OFF。
    - トレードリリース (Surface Slap): 対象魚の選択。
    - **全部釣り上げる**: ON/OFF（デフォルト：OFF）。
- **ルアー設定**: 
    - 種類：アンビシャス、モデスト、使用しない。
    - 使用回数 ($n$): 0〜3回。
    - **アクション結果の指定**: 各ステップ $t$ における「何もなし」「発見」「型確定」の状態選択。これにより32パターンのうち特定の1シナリオを抽出して分析する。
- **ターゲット設定**: 期待釣果を算出する対象魚種を選択。

### 2.2 期待釣果（効率）の計算式
3分間（180秒）におけるターゲット魚の期待釣果 $E_{target}$ を算出する。

$$E_{target} = \frac{180}{T_{cycle}} \times P(target)$$

#### A. 1サイクル所要時間 ($T_{cycle}$) の構成
ユーザー指定のシナリオに基づき、以下の合算とする。
1. **キャスト硬直 ($D_{cast}$)**: 0秒。
2. **アクション合計時間**: $D_{action} \times n$ （GDS 7.4より $D_{action} = 1.8$秒）。
3. **ヒット待機時間 ($T_{bite}$)**: 
    - ターゲットまたは他魚種がヒットする場合：基礎待機時間 $\times$ 撒き餌補正(0.6)。
    - 何も釣れない場合：GDS規定の最大待機時間（または $null$ 時は計算不可）。
4. **終了動作時間 ($D_{end}$)**:
    - **「全部釣り上げる」が OFF の場合**: 常に竿上げ時間 $D_{cancel}$（GDS 7.3より 2.5秒）。
    - **「全部釣り上げる」が ON の場合**: 
        - 魚がヒットした時：その魚種の釣り上げ動作時間 $D_{hook}$（マスタ参照）。
        - ヒットしなかった時：竿上げ時間 $D_{cancel}$ (2.5秒)。

#### B. 重み補正倍率 ($M$) の適用 (GDS 5.3)
ルアー使用回数 $n$ に応じて、適合する型の通常魚に以下の倍率を適用する。
- $n=1$ (L1): 1.2倍
- $n=2$ (L2): 1.5倍
- $n=3$ (L3): 2.0倍
- 使用しない/不適合: 1.0倍

### 2.3 計算エンジンの動作フロー
1. **シナリオ特定**: ユーザーが入力したアクション履歴から、GDS 6.3の32パターンのうち1つを特定。
2. **確率参照**: 
    - 隠し魚：特定パターンの $i, n, G$ 状況に応じた「隠しヒット率（9種）」を参照。
    - 通常魚：補正倍率 $M$ とトレードリリース ($w=0$) を適用し、残確率を分配。
3. **時間計算**: 上記 2.2-A に基づき、そのシナリオにおける期待時間を算出。
4. **データ不足判定**: 参照した確率に $null$ が含まれる場合、期待値は算出せず「データ不足」と表示する。

---

## 第3章：UI実装およびアウトプット仕様

### 3.1 ターゲット分析表示 (Main Display)
- **3分間期待釣果**: 算出した匹数を大きく表示。
- **ターゲットヒット率**: そのシナリオにおける純粋な当選確率（％）。

### 3.2 魚種一覧テーブル (Fish List Table)
現在の設定（環境・スキル・指定アクション履歴）において出現しうる全魚種をリスト表示。
- 列：魚種名、演出（!数）、ヒット確率（％）、動作時間。

---

## 第4章：更新履歴 (Changelog)
- **v1.5**: 
    - $D_{cast}=0$ を確定。
    - ルアー重み補正 $M$ を GDS 5.3 に準拠（1.2x / 1.5x / 2.0x）。
    - 「全部釣り上げる」フラグによるサイクル終了時間の分岐論理を追加。