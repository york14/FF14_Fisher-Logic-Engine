# Fisher Logic Engine (FLE) システム仕様書 v2.0

**最終更新**: 2026年1月
**対象バージョン**: FLE Simulator v2.0

---

## 1. システム概要

### 1.1 目的

ゲーム内の釣りシステムにおける、特定の魚を釣り上げるまでの「期待待機秒数」を数学的に計算・可視化するシミュレータです。

### 1.2 構成ファイル

* `index.html`: UIレイアウト定義
* `assets/style.css`: スタイル定義
* `assets/main.js`: メインロジック
* `logic_master.json`: マスタデータ（バージョン 2.0.0）

### 1.3 データフロー

`[JSONロード] → [UI選択] → [確率計算] → [期待値計算] → [結果表示]`

※計算プロセスは `[デバッグ情報生成]` として可視化されます。

---

## 2. 用語定義（コード対応表）

| 日本語名称 | コード上の表記 | 定義・役割 |
| --- | --- | --- |
| **釣り場** | `currentSpot` | 基礎重みや出現魚種を定義する最上位の場所区分。 |
| **天気/時間** | `currentWeather` | 出現確率を左右する環境条件。 |
| **餌** | `currentBait` | 出現魚種と基礎重みを決定する選択要素。 |
| **ターゲット魚** | `targetFishName` | 効率計算（期待時間算出）の対象となる特定の魚種。 |
| **隠し魚** | `hiddenFishName` | 発見アクション後にのみ出現する特殊な魚種。 |
| **トレードリリース** | `tradeSlapFish` | 抽選対象から除外する（重みを0にする）スキル。 |
| **型** | `type` | `small_jaws`（小型） / `large_jaws`（大型）の区分。 |
| **期待時間** | `expectedTime` | ターゲットを釣り上げるまでに平均で何秒かかるかの指標。 |

---

## 3. データ構造仕様 (`logic_master.json`)

### 3.1 `fish` オブジェクト

各魚種の物理属性を保持します。

* `type`: `small_jaws` または `large_jaws`
* `vibration`: 演出表記（`!` / `!!` / `!!!`）
* `hook_time`: フッキング完了までの動作時間（秒）
* `is_hidden`: 隠し魚かどうかの真偽値
* `can_trade`: トレードリリース可能かどうかの真偽値

### 3.2 `spots` オブジェクト

釣り場ごとの選択可能リストを定義します。

* `weathers`: 利用可能な天気条件の配列
* `baits`: 利用可能な餌の配列
* `fish_list`: その釣り場に出現しうる魚種名の配列

### 3.3 `weights` オブジェクト

環境条件ごとの基礎データを定義します。キーは `釣り場|天気|餌` です。

* `fish`: 魚種名
* `weight`: 基礎重み
* `bite_time`: 基礎待機時間（秒）

### 3.4 `probabilities` オブジェクト

ルアーアクションに応じた確率パラメータを保持します。キー検索を行い、該当行を取得します。

* `disc_rates`: 発見確率の配列（1-3回目）
* `guar_rates_nodisc`: 未発見時の型確定確率の配列（1-3回目）
* `guar_rates_after_disc`: 発見済時の型確定確率（オブジェクト形式）
* `hidden_hit_rates`: 各発見シナリオ（ID）ごとの隠し魚ヒット率

---

## 4. 計算ロジック：時間算出

### 4.1 定数

```javascript
const GDS = {
    D_CAST: 1.0,    // キャスト動作時間
    D_LURE: 2.5,    // ルアー動作時間
    D_BLK: 2.5,     // ルアー後の空白時間
    D_CHUM: 1.0,    // 撒き餌使用動作時間
    D_REST: 2.0,    // 竿上げ動作時間（リリース等）
    C_CHUM: 0.6,    // 撒き餌による待機時間短縮係数
    M_N1: 1.5,      // ルアー1回使用時の重み倍率
    M_N2: 2.0,      // ルアー2回使用時の重み倍率
    M_N3: 6.0       // ルアー3回使用時の重み倍率
};

```

### 4.2 実効待機時間 (`waitTime`) の導出

魚種ごとの待機時間は、スキル補正とルアーによる物理的制約の大きい方を採用します。

1. **補正待機時間 (`biteTime`)**:


2. **ルアー制約時間 (`lureTime`)**:



※使用しない場合は0
3. **実効待機時間 (`waitTime`)**:



### 4.3 サイクル時間 (`cycleTime`)

1投あたりの総拘束時間です。


* : 撒き餌ありなら `GDS.D_CHUM` (1.0)、なしなら 0。
* : ターゲット魚または「外道も全て釣る」ON時は魚固有の `hook_time`、それ以外（外道リリース）は `GDS.D_REST` (2.0)。

---

## 5. 計算ロジック：確率と期待効率

### 5.1 重み補正ロジック

通常魚の基礎重み  に以下のルールで倍率  を適用します。

* **型一致**: 魚の型と使用ルアーが一致する場合、回数に応じた  （1回: 1.5, 2回: 2.0, 3回: 6.0）を適用。
* **不一致・型確定**: 最後のアクションが「型確定」かつ型が不一致なら 。
* **不一致・非型確定**: 型が不一致でも、最後が「型確定」以外なら 。
* **トレードリリース**: 選択された魚種は 。

### 5.2 ヒット確率の算出

1. **隠し魚ヒット率 ()**: シナリオIDに基づき `hidden_hit_rates` から取得。
2. **通常魚ヒット率 ()**:



### 5.3 ターゲットヒット時間期待 (`expectedTime`)

1. **平均サイクル時間 ()**:


2. **期待時間導出**:



※ターゲットを釣り上げる動作時間（成功時のコスト）を除外することで、純粋にヒットするまでの待ち時間を算出。

---

## 6. ルアーアクション・シナリオ理論

### 6.1 各ステップの成立確率

UIで選ばれたアクションの組み合わせが成立する確率を算出します。

| 状態 | 選択した結果 | ステップ成立確率の計算式 |
| --- | --- | --- |
| **未発見時** | **発見** | `disc_rates[t-1]` |
|  | **型確定** | `(1 - disc_rates[t-1]) * guar_rates_nodisc[t-1]` |
|  | **何もなし** | `(1 - disc_rates[t-1]) * (1 - guar_rates_nodisc[t-1])` |
| **発見済時** | **型確定** | `guar_rates_after_disc[key]` |
|  | **何もなし** | `1 - guar_rates_after_disc[key]` |

### 6.2 シナリオ発生確率の積算

全ステップの成立確率  を掛け合わせた総乗で算出します。


UI上に「ルアー効果シナリオ発生確率」として表示されます。

### 6.3 隠し魚判定キー (ID)

隠し魚のヒット率を特定するためのキー文字列です。

* 形式: `n{lure_count}_d{discovery_step}_g{guarantee_steps}`
* 例: 3回使用、1回目に発見、2と3回目に型確定なら `n3_d1_g23`。

---

## 7. UI（ユーザーインターフェース）仕様

### 7.1 レイアウト

* **構成**: 3つの垂直パネル（設定、結果、詳細）。
* **リサイザー**: 各カラムの境界にあるバーで幅を調整可能。
* **設定（左）**: デフォルト 260px
* **詳細（右）**: デフォルト 380px（文字情報を読みやすくするため広めに設定）



### 7.2 表示仕様

* **結果テーブル**: 魚種ごとのヒット率、待機時間、サイクル時間を一覧表示。
* **エラー表示**: 計算不能時はテーブル内に赤字でエラー内容を表示。
* **詳細ビュー**: 定数、シナリオ解析（検索キー・確率配列）、重み内訳（確率付）、計算トレースを表示。

---

## 8. エラーハンドリングと制約

### 8.1 エラーメッセージ

* **制約エラー**: 「発見」を複数回選択した場合など。
* **データ不足エラー**: `probabilities` の該当確率値が `null` の場合。

### 8.2 データ制約

* **NULL値**: 「データ未定義」を意味し、**計算を停止してエラーを表示します**（0として扱いません）。
* **トレード不可**: 「外道も全て釣る」ON時はトレード機能が無効化（なし固定）されます。

---

## 9. 技術仕様

* **対応ブラウザ**: Chrome 90+, Firefox 88+, Safari 14+
* **使用技術**: HTML5, CSS Grid/Flexbox, Vanilla JavaScript (ES6+)