# Fisher Logic Engine (FLE) システム仕様書 v2.1

**最終更新**: 2026年1月
**対象バージョン**: FLE Simulator v2.1

---

## 1. システム概要

### 1.1 目的

ゲーム内の釣りシステムにおける、特定の魚を釣り上げるまでの「期待待機秒数」を数学的に計算・可視化するシミュレータです。
v2.0以降では、単一の結果だけでなく、複数の分岐を含む「釣り戦略（スキル回し）」全体の効率を評価・比較する機能を備えます。

### 1.2 構成ファイル

* `index.html`: UIレイアウト定義
* `assets/style.css`: スタイル定義
* `assets/main.js`: メインロジック
* `logic_master.json`: マスタデータ（バージョン 2.0.0）

### 1.3 データフロー

`[JSONロード] → [モード選択(手動/戦略)] → [確率計算] → [期待値計算] → [結果表示]`

---

## 2. 用語定義（コード対応表）

| 日本語名称 | コード上の表記 | 定義・役割 |
| --- | --- | --- |
| **釣り場** | `currentSpot` | 基礎重みや出現魚種を定義する最上位の場所区分。 |
| **天気/時間** | `currentWeather` | 出現確率を左右する環境条件。 |
| **餌** | `currentBait` | 出現魚種と基礎重みを決定する選択要素。 |
| **ターゲット魚** | `targetFishName` | 効率計算（期待時間算出）の対象となる特定の魚種。 |
| **隠し魚** | `hiddenFishName` | 発見アクション後にのみ出現する特殊な魚種。 |
| **トレードリリース** | `tradeSlapFish` | 抽選対象から除外する（重みを0にする）スキル。 |
| **戦略プリセット** | `strategy_presets` | 「基本3回使用だが型確定で止める」などの行動ルール定義。 |

---

## 3. データ構造仕様 (`logic_master.json`)

### 3.1 `fish` オブジェクト
各魚種の物理属性（`type`, `vibration`, `hook_time`, `is_hidden`）を保持。

### 3.2 `spots` / `weights` / `probabilities`
釣り場定義、基礎重み、ルアーアクションごとの確率パラメータを保持。
※`probabilities` の値が `null` の場合は「データなし」として計算を中断します。

### 3.3 `strategy_presets` オブジェクト
戦略ごとの対象シナリオIDリストを定義します。
* `id`: 戦略ID（例: `b3_guar_stop`）
* `eligible_scenarios`: この戦略を採用した際に発生しうる全シナリオID（`n3_d0_g0`, `n1_d0_g1` 等）の配列。

---

## 4. 計算ロジック：個別シナリオ解析

### 4.1 基礎計算
手動モード、および戦略モードの各シナリオ単位での計算です。

1. **実効待機時間**: 撒き餌短縮後の時間と、ルアー硬直時間の長い方を採用。
2. **サイクル時間**: $T_{Cycle} = D_{pre} + D_{CAST} + T_{Final} + D_{end}$
3. **ヒット確率**: 重み配分による抽選確率に、隠し魚出現率を考慮して算出。

---

## 5. 計算ロジック：戦略評価（New）

複数のシナリオが含まれる「戦略」の効率を評価するロジックです。

### 5.1 戦略の平均指標算出

戦略に含まれる全シナリオ $i$ について、発生確率 $P(S_i)$ で重み付けした平均値を算出します。

1. **戦略平均ヒット率 ($P_{strat}$)**:
   $$P_{strat} = \sum_{i} (P(S_i) \times HitRate(S_i))$$
2. **戦略平均サイクル時間 ($E[T_{cycle}]_{strat}$)**:
   $$E[T_{cycle}]_{strat} = \sum_{i} (P(S_i) \times T_{cycle}(S_i))$$
   ※$T_{cycle}(S_i)$ は、そのシナリオにおける全魚種の平均サイクル時間。

### 5.2 戦略の期待時間算出

ターゲット1匹を獲得するために必要な平均総時間（成功回のフッキング時間を除く待機時間）を算出します。

$$E[T_{hit}] = \frac{E[T_{cycle}]_{strat} - (P_{strat} \times D_{end}(target))}{P_{strat}}$$

* $D_{end}(target)$: ターゲット固有のフッキング動作時間。

### 5.3 平均キャスト回数
$$N_{cast} = 1 / P_{strat}$$

---

## 6. ルアーアクション・シナリオ理論

（v2.0と同様：各ステップの成立確率積算によりシナリオ発生確率を算出）

---

## 7. UI（ユーザーインターフェース）仕様

### 7.1 レイアウト構成

* **全体**: 最大幅制限（2400px）付きの3カラム構成。
* **左カラム（設定）**: 幅360px。
    * **共通設定**: 釣り場、天気、餌、ターゲット。
    * **モード切替**: 「手動設定」と「戦略評価」をタブで切り替え。
* **中央カラム（結果）**: 最小500px。
    * コンテンツは最大幅720pxで左寄せ（ウルトラワイド対応）。
    * **戦略比較カード**: セットA・Bの期待時間、平均サイクル、Hit率等を並列表示。
* **右カラム（詳細）**: 幅420px。
    * **開閉機能**: タイトルクリックで幅50pxに縮小可能。
    * **デバッグ情報**: 定数、各戦略のシナリオ別確率・期待値の内訳テーブルを表示。

### 7.2 特殊表示

* **Top3 ランキング**: 戦略評価時、発生確率が高いシナリオ上位3つと、Hit率が高いシナリオ上位3つを個別に表示。
* **エラー表示**: データ欠損（NULL）時は赤字で警告を表示し、計算を停止。

---

## 8. 技術仕様

* **対応ブラウザ**: Chrome 90+, Firefox 88+, Safari 14+
* **使用技術**: HTML5, CSS Grid/Flexbox, Vanilla JavaScript (ES6+)