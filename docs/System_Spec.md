# Fisherman Logic Engine (FLE) - システム仕様書 v2.3
**フェーズ1：シミュレーション基盤と期待待機時間指標の確立（完了）**

## 第1章：データ構造とマスタ定義

### 1.1 統合データ (fle_master_db.json)
4つのCSVマスタを `FLE Master Converter` によって統合した単一のJSONファイル（`version: 1.1.0`）をシステム正本とする。
- **データ厳密性**: CSV内の空白セルは「`null`（未定義）」として保持する。数値「`0`」とは明確に区別し、計算中に `null` を検知した場合はエラーとして処理を停止する。
- **整合性管理**: 「`釣り場`（Spot）」「`魚種`（Fish）」「`天気/時間`（Weather）」「`餌`（Bait）」の名称は、全マスタおよびUI間で半角・全角を含め完全に一致している必要がある。

### 1.2 魚種マスタの属性
各「`魚種`（Fish）」は以下のプロパティを持つ。
- `type`: 型（`small_jaws`（小型） / `large_jaws`（大型））。
- `vibration`: 演出（`!` / `!!` / `!!!`）。
- `hook_time`: `釣り上げ動作時間` ($D_{Hook}$)。
- `is_hidden`: `隠し判定`（隠し魚か否か）。
- `can_slap`: `トレードリリース` 可能フラグ。

---

## 第2章：計算ロジックとアルゴリズム

### 2.1 物理定数 (GDS v3.14.0 準拠)
システム内で「`GDS`」定数オブジェクトとして保持される。
- `D_CAST`: **キャスト硬直** (1.0s)
- `D_LURE`: **ルアー硬直** (2.5s)
- `D_BLK`: **ルアー後空白** (2.5s)
- `D_REST`: **竿上げ硬直** (2.0s)
- `C_CHUM`: **撒き餌補正係数** (0.6)

### 2.2 時間算出ロジック
1. **実効待機時間 (`tFinal`)**:
   「`撒き餌`（Chum）」補正後の待機時間と、ルアーによるヒット禁止時間の長い方を採用する。
   $$T_{Final} = \max(T_{Bite} \times C_{Chum}, D_{Cast} + (n \times D_{Lure}) + D_{Blk})$$
2. **1サイクル合計時間 (`tCycle`)**:
   $$T_{Cycle} = D_{Skill\_Pre} + D_{Cast} + T_{Final} + D_{End}$$
   - `D_End`: 「`全部釣り上げる`（Catch All）」がONなら魚固有の `hook_time`、OFFなら一律 `D_REST`。

### 2.3 効率評価指標
- **ターゲットヒット期待時間 (`efficiency`)**:
  ターゲットがヒットするまでに平均で何秒かかるかを算出する（ターゲットヒット時の動作時間はロスに含めない）。
  $$E[T_{Hit}] = \frac{E[T_{Cycle, Avg}] - (P_{Target} \times D_{End, Target})}{P_{Target}}$$

---

## 第3章：ルアーアクション論理

### 3.1 抽選状態の遷移
- **`発見`（Discovery）**: 1回でも発生すれば、以降のステップに関わらず「隠し魚」が抽選対象に含まれる。
- **`型確定`（Guarantee）**: 揮発性の効果。**最後のアクション**が「型確定」の場合のみ、不適合魚種の重み補正（$M$）を `0` とし、抽選から完全に除外する。
- **`重み補正`（$M$）**: 使用回数 $n$ に応じて適合魚種に適用（$n=1: 1.5, n=2: 2.0, n=3: 6.0$）。

---

## 第4章：UI（ユーザーインターフェース）仕様

### 4.1 結果テーブル (`res-table-body`)
計算結果をリアルタイムに一覧表示する。表示順は釣り場マスタの定義（`spot.fish`）に準拠する。
- **ヒット率**: ターゲット魚および他魚種の個別確率を百分率で表示。
- **待機時間**: 実効待機時間（$T_{Final}$）を表示。
- **サイクル時間**: 1サイクルの総拘束時間（$T_{Cycle}$）を表示。
- ※ヒット率 0% の魚種は、時間項目に「`-`」を表示する。

### 4.2 デバッグ・解析ビュー (`debug-panel`)
中央カラムに配置され、計算プロセスの透明性を確保する。
- **横方向の開閉機能**: タイトルクリックにより `debug-collapsed` クラスを切り替え、パネルを横方向に伸縮させる。閉じた状態では縦書きのタイトルのみが表示される。
- **数式の実行トレース**:
    1. **確率シナリオ内訳**: 現在のアクションによる `P(Pattern)` の乗算プロセス。
    2. **重み分配明細**: `base_weight`（基礎重み）から `M` 補正、トレードリリースを反映した最終重みの算出。
    3. **期待時間導出**: $E[T_{Cycle}]$ から $E[T_{Hit}]$ に至る中間式の可視化。

---

## 第5章：開発ロードマップ

### 5.1 第二段階 (Phase 2)
- **32パターンの自動合算**: 特定のアクションを選択せずとも、指定したルアー回数 $n$ における全パターンの加重平均効率を算出する。
- **ターゲット・フッキング**: 「ターゲットのみ釣り上げ、他は竿上げ」という運用を想定した分岐ロジックの導入。

### 5.2 第三段階 (Phase 3)
- **最適戦略の自動提案**: 全アクション回数（0～3回）の中で最も $E[T_{Hit}]$ が優れている設定をハイライト表示。
- **マスタ整合性バリデーター**: CSVロード時に、名称の半角全角ミスやデータ欠損を検知し警告する機能。