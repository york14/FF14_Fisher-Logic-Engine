このFLE Simulatorシステムをレビューしました。以下、致命的な点と改善推奨点を報告します。

## ①致命的な点

### 1. **確率計算ロジックの重大な不整合**
**場所**: `main.js` の `calculate()` 関数内、`patternProb` 計算部分

```javascript
if (val === "発見") { p_t = dRate; found = true; foundAt = idx + 1; }
else if (val === "型確定") { p_t = (1 - dRate) * gRate; }
else { p_t = (1 - dRate) * (1 - gRate); }
```

**問題点**: 
- 「発見」時に `p_t = dRate` としていますが、これは「発見**かつ**その後の処理」の確率ではなく、単に発見確率のみです
- UIの説明「シナリオ発生確率」と実装が不一致。ユーザーは「このパターン全体が起きる確率」と解釈しますが、実装は「各ステップの条件付き確率の積」を計算しています

### 2. **データ不整合時のクラッシュリスク**
**場所**: `calculate()` 関数内の複数箇所

```javascript
const meta = DB.fish[f.name];
// ... 後でmeta.typeを参照
const isMatch = (meta && meta.type === lureJaws);
// ... しかし以下では存在チェックなし
const dEnd = elCatch.checked ? meta.hook_time : GDS.D_REST;
```

**問題**: `meta` が `undefined` の場合、`meta.hook_time` でクラッシュします。`weights` に存在するが `fish` に定義がない魚種があるとエラーになります。

### 3. **隠し魚の重複カウント**
**場所**: `calculate()` 関数

```javascript
currentWeights.forEach(f => {
    if (f.name === hiddenFish) return; // スキップ
    // ... 重み計算
});
// ... 後で
const prob = (f.name === hiddenFish) ? debugPHidden : (detail.finalW / debugSumW) * (1 - debugPHidden);
```

**問題**: `currentWeights` に隠し魚が含まれている場合、重み計算ではスキップしますが、最終的な確率計算では `debugPHidden` を使用。しかし `currentWeights` に隠し魚が**含まれていない**場合、確率が計算されない魚が存在する可能性があります。

### 4. **NULL値の不適切な処理**
**場所**: JSON内の `probabilities` データと、それを使用する箇所

```javascript
if (dRate === null || gRate === null) { 
    debugData.error = `未発見時Null(確率${idx+1})`; 
    showCalculationError(debugData.error); 
    return; 
}
```

**問題**: JSONデータに `null` が多数含まれていますが、これが「データ未定義」なのか「確率0」なのか不明確です。例えば、エレクトロベタ・サンダーレッド・ヘリテージグルーパーの確率は全て `null` ですが、これらの魚種が選択された場合の挙動が未定義です。

### 5. **撒き餌効果の適用範囲の矛盾**
**場所**: `calculate()` 関数

```javascript
const tPrime = f.t * (elChum.checked ? GDS.C_CHUM : 1.0);
const tMin = GDS.D_CAST + (lureN * GDS.D_LURE) + GDS.D_BLK;
const tFinal = Math.max(tPrime, tMin);
```

デバッグ表示では:
```javascript
補正待機 $T'_{Bite}$: ${t.tPrime.toFixed(1)}s (基礎:${(t.tPrime / (elChum.checked ? GDS.C_CHUM : 1.0)).toFixed(1)}s
```

**問題**: 撒き餌(Chum)を使用すると待機時間が0.6倍になりますが、`tMin`(ルアー使用時の最小時間)は撒き餌の影響を受けません。これが意図的な仕様なのか不明確で、ユーザーは混乱する可能性があります。

---

## ②致命的ではない点

### 1. **パフォーマンス問題**
- `calculate()` が全てのイベントリスナーから呼ばれるため、不要な再計算が多発
- `currentWeights.forEach()` と `resList.find()` の二重ループでO(n²)
- JSONデータが大きく、毎回全体を走査

**推奨**: 
```javascript
// キャッシュ機能の追加
let cachedKey = "";
let cachedResult = null;

function calculate() {
    const key = `${elSpot.value}|${elWeather.value}|${elBait.value}|...`;
    if (key === cachedKey) return cachedResult;
    // ... 計算処理
    cachedKey = key;
    cachedResult = result;
}
```

### 2. **データ構造の非効率性**
- `probabilities` のキーが文字列結合で、検索が遅い
- `weights` も同様に文字列キー

**推奨**: ネストされたオブジェクト構造に変更
```javascript
{
  "probabilities": {
    "アレクサンドリア旧市街": {
      "霧晴れ12-16": {
        "紅サシ": {
          "ゴールデングルーパー": { /* ... */ }
        }
      }
    }
  }
}
```

### 3. **マジックナンバーの多用**
```javascript
let gIdx = (foundAt === 1) ? (idx === 1 ? 0 : 1) : 2;
```

**推奨**: 定数化と命名
```javascript
const GUARANTEE_INDEX = {
    FOUND_AT_FIRST_STEP_SECOND: 0,
    FOUND_AT_FIRST_STEP_LATER: 1,
    FOUND_AT_LATER_STEP: 2
};
```

### 4. **エラーメッセージの国際化対応不足**
日本語と英語が混在:
```javascript
debugData.error = "制約エラー: 発見は1サイクルに1回しか発生しません。";
```

### 5. **UI更新の非原子性**
```javascript
tbody.innerHTML = '';
masterOrder.forEach(name => {
    // ... DOM操作
    tbody.appendChild(tr);
});
```

**推奨**: DocumentFragmentを使用
```javascript
const fragment = document.createDocumentFragment();
masterOrder.forEach(name => {
    // ... tr作成
    fragment.appendChild(tr);
});
tbody.innerHTML = '';
tbody.appendChild(fragment);
```

### 6. **変数名の不統一**
- `elSpot`, `elWeather` (キャメルケース)
- `D_CAST`, `M_N1` (スネークケース)
- `debugData`, `pData` (混在)

### 7. **不要な計算の重複**
```javascript
// デバッグ表示で再計算
(基礎:${(t.tPrime / (elChum.checked ? GDS.C_CHUM : 1.0)).toFixed(1)}s
```
基礎値は既に計算済みなのに、表示時に再計算しています。

### 8. **HTMLの構造的問題**
- インラインスタイルの多用（`<small id="debug-toggle-msg" style="font-size:0.6rem; color:var(--text-muted);">`）
- CSSクラスで管理すべき

### 9. **アクセシビリティの欠如**
- ボタンに `aria-label` なし
- チェックボックスとラベルが `<label>` タグで結びついていない
- キーボード操作への配慮不足

### 10. **コメントの不足**
特に `patternProb` 計算部分は複雑なロジックなのに説明がありません。

---

## 優先度順の修正推奨

**最優先（今すぐ修正）**:
1. NULL値処理の明確化とエラーハンドリング強化
2. `meta` 存在チェックの徹底
3. 確率計算ロジックと説明文の整合性確保

**高優先度**:
4. データ構造の見直し
5. パフォーマンス改善（キャッシュ導入）
6. 変数名・定数の統一

**中優先度**:
7. UI更新の最適化
8. エラーメッセージの整理
9. アクセシビリティ対応

このシステムは全体的によく設計されていますが、エッジケースの処理とパフォーマンスに改善の余地があります。