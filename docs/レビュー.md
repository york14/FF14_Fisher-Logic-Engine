コードレビューを実施しました。以下、発見した問題点と改善提案をまとめます。

## 🔴 致命的な問題

### 1. **未定義変数の参照エラーの可能性**
```javascript
// main.js Line 297付近
const isCatchAll = document.getElementById('isCatchAll');
isCatchAll.addEventListener('change', () => {
    // ...
    if (isCatchAll.checked) {
        ['manualTradeSlap', 'stratATrade', 'stratBTrade'].forEach(id => {
            const el = document.getElementById(id);
            if (el) { el.value = 'なし'; el.disabled = true; }
        });
    }
```
**問題**: `'なし'` という値がオプションに存在しない可能性があります。HTMLでは `value="なし"` ですが、data内では漢字表記なので、一貫性を確認する必要があります。

### 2. **null参照のリスク**
```javascript
// calculateScenarioStats関数内
const targetStat = allFishStats.find(s => s.isTarget);
const targetHitRate = targetStat ? targetStat.hitRate : 0;
// ...しかし後続処理で
const tStat = stats.allFishStats.find(s => s.isTarget);
if (!tStat) {
    document.getElementById('debug-calc-target').textContent = "ターゲット情報なし";
    // ...
}
const targetHook = stats.debugData.targetHook; // tStatがnullの場合undefinedになる
```
**問題**: `targetStat`が見つからない場合、`stats.debugData.targetHook`が`undefined`になり、後続の計算でNaNが発生する可能性があります。

### 3. **配列インデックスの境界チェック不足**
```javascript
// Line 470付近
const pDisc = probData.disc_rates[idx];
const pGuar = probData.guar_rates_nodisc[idx] / 100.0;
```
**問題**: `idx`が配列の範囲外になる可能性がありますが、チェックは`null`の確認のみです。

---

## ⚠️ 修正推奨事項

### 4. **非効率な配列探索の繰り返し**
```javascript
function renderResultTable(stats, targetName, scnStr, scnProb, avgCycle) {
    stats.forEach(s => {
        const tr = document.createElement('tr');
        if (s.name === targetName) tr.classList.add('row-target');
        // ...
    });
}
```
**改善案**: ターゲットかどうかは既に`s.isTarget`フラグで判定可能なので、文字列比較は不要です。
```javascript
if (s.isTarget) tr.classList.add('row-target');
```

### 5. **重複するDOM操作**
```javascript
// updateStrategyPresetsFilter関数
['A', 'B'].forEach(set => {
    const lureVal = document.getElementById(`strat${set}Lure`).value;
    const presetSel = document.getElementById(`strat${set}Preset`);
    
    Array.from(presetSel.options).forEach(opt => {
        // 全optionを毎回走査
    });
});
```
**改善案**: オプション数が多い場合は非効率です。一度だけ有効/無効を判定して適用する方が良いでしょう。

### 6. **マジックナンバーの多用**
```javascript
const GDS = {
    D_CAST: 1.0, D_LURE: 2.5, D_BLK: 2.5, D_CHUM: 1.0, D_REST: 2.0,
    C_CHUM: 0.6, M_N1: 1.5, M_N2: 2.0, M_N3: 6.0
};
```
これは良いですが、以下のような場所に説明が欲しい:
```javascript
if (e.clientX > 200 && e.clientX < 500) // 200, 500は何を意味する?
```

### 7. **Error handling の一貫性不足**
```javascript
try {
    masterDB = JSON.parse(e.target.result);
    // ...
} catch (err) { 
    alert("Invalid JSON"); // ユーザーにとって不親切
}
```
**改善案**: より具体的なエラーメッセージを表示すべきです。
```javascript
} catch (err) { 
    alert(`JSONファイルの読み込みに失敗しました: ${err.message}`); 
}
```

### 8. **計算ロジックの可読性**
```javascript
// Line 490付近 - ネストが深すぎる
if (!found) {
    if (probData.disc_rates[idx] === null) return { error: ... };
    const pDisc = probData.disc_rates[idx];
    const pGuar = probData.guar_rates_nodisc[idx] / 100.0;
    const pD = pDisc / 100.0;
    
    if (action === 'disc') { 
        stepProb = pD; 
        found = true; 
        foundStep = i; 
    }
    else if (action === 'guar') { 
        stepProb = (1.0 - pD) * pGuar; 
    }
    else { 
        stepProb = (1.0 - pD) * (1.0 - pGuar); 
    }
```
**改善案**: 関数に切り出すべきです。
```javascript
function calculateStepProbability(action, probData, idx, found, foundStep, i) {
    // ...
}
```

### 9. **CSS の重複定義**
```css
/* style.css */
.panel { 
    background: var(--panel-bg); 
    padding: 20px 30px;
    overflow-y: auto; 
    /* ... */
}

/* 後で上書き */
#panel-right.collapsed { 
    padding: 10px 5px; 
    /* ... */
}
```
これは問題ありませんが、BEM記法などを使うとより明確になります。

### 10. **メモリリークの可能性**
```javascript
// initResizers関数内
resizerLeft.addEventListener('mousedown', (e) => { 
    e.preventDefault(); 
    document.addEventListener('mousemove', resizeL); 
    document.addEventListener('mouseup', stopL); 
});
```
**問題**: `removeEventListener`が正しく動作しない場合、イベントリスナーが残り続ける可能性があります。
**改善案**: AbortControllerを使用するか、リスナーを明示的に管理します。

---

## 🟡 その他の気づき

### 11. **データ構造の改善余地**
```javascript
// probabilities配列が長大で、検索が線形
const probData = masterDB.probabilities.find(row =>
    row.spot === config.spot &&
    row.weather === config.weather &&
    // ...
);
```
**改善案**: 初期化時にMapやオブジェクトに変換してO(1)検索にする。
```javascript
const probIndex = {};
masterDB.probabilities.forEach(p => {
    const key = `${p.spot}|${p.weather}|${p.bait}|${p.lure_type}|${p.trade_target}`;
    probIndex[key] = p;
});
```

### 12. **HTML構造の動的生成が多い**
テンプレート文字列で大量のHTMLを生成していますが、セキュリティ上XSSのリスクがあります（現状はユーザー入力を直接埋め込んでいないので問題ないですが、将来的に注意）。

---

## ✅ 良い点

- グローバル変数を最小限に抑えている
- 定数を明示的に定義している
- コメントが適切に配置されている
- UIとロジックがある程度分離されている

---

## 📋 推奨修正の優先順位

1. **高**: null/undefined参照の防御的プログラミング
2. **高**: 配列境界チェックの強化
3. **中**: 関数の分割とネストの削減
4. **中**: データ構造の最適化（検索の高速化）
5. **低**: CSS命名規則の統一
6. **低**: マジックナンバーへのコメント追加

詳細な修正コードが必要であれば、特定の箇所について提示できます。