# Fisherman Logic Engine (FLE) システム仕様書 v2.0

**最終更新**: 2026年1月
**対象バージョン**: FLE Simulator v2.0 (Strategy Enhanced)

---

## 1. システム概要

### 1.1 目的

本システムは、ゲーム内の「ヌシ釣り」コンテンツにおける、特定の魚を釣り上げるまでの「期待待機秒数」および「時間対効果（時給）」を数学的にシミュレーションする計算エンジンである。
v2.0では、単一シナリオの詳細評価に加え、複数の分岐を含む「戦略（Strategy）」全体の期待値を算出・比較する機能を搭載する。

### 1.2 構成ファイル

* **index.html**: アプリケーションのエントリーポイント。UIレイアウト（モード切替タブ等）を含む。
* **assets/style.css**: 画面スタイル定義。
* **assets/main.js**: 計算ロジックのコアスクリプト。物理定数定義、新ID解析、シミュレーション実行、DOM操作を担当。
* **logic_master.json**: マスタデータ（旧 `fle_master_db.json`）。釣り場、確率、戦略プリセット等を格納。
* **data_converter.html**: 開発用ツール。CSVファイル群から `logic_master.json` を生成する。

### 1.3 データフロー

1. `init()`: `logic_master.json` を非同期読み込み。
2. ユーザー入力: 釣り場、戦略、シナリオ等の変更を検知。
3. `updateSimulation()`: 入力値に基づき計算プロセスを開始。
4. `parseScenarioId()`: ID文字列を数値パラメータへ解析。
5. `calculateScenarioStats()` / `calculateStrategyAverage()`: 各種期待値を算出。
6. DOM更新: 結果パネルおよびデバッグパネルへ描画。

---

## 2. 用語定義（コード対応表）

| 日本語名称 | コード上の表記 | 定義・役割 |
| --- | --- | --- |
| **釣り場** | `currentSpot` | 基礎重みや出現魚種を定義する最上位の場所区分。 |
| **天気/時間** | `currentWeather` | 出現確率を左右する環境条件。 |
| **餌** | `currentBait` | 出現魚種と基礎重みを決定する選択要素。 |
| **ターゲット** | `targetFishName` | 期待値計算の対象となる魚種。 |
| **トレード対象** | `tradeFish` | 「トレードリリース」スキルにより出現抽選から除外する魚種。 |
| **撒き餌** | `isChum` | 「撒き餌」スキル使用有無。待機時間を短縮する。 |
| **ルアーシナリオ** | `manualLureScenario` | 手動モード時、ユーザーが指定する具体的なアクション結果（新ID体系）。 |
| **戦略プリセット** | `strategyPreset` | 戦略モード時、複数のシナリオを束ねた行動指針（例：発見時延長、型確優先など）。 |

---

## 3. 物理定数と時間計算ロジック

本システムでは、GDS (Game Design Standard) v3.14.0 に準拠した以下の定数を使用する。

### 3.1 物理定数 (Global Constants)

* **D_CAST (1.0s)**: キャスト（竿を振る）動作の硬直時間。
* **D_LURE (2.5s)**: ルアーアクション1回あたりの動作時間。
* **D_BLK (2.5s)**: ルアーアクション終了後のヒット不可空白時間（Blank Time）。
* **D_CHUM (1.0s)**: 撒き餌動作の硬直時間（本シミュレータではサイクルに含まず、効果のみを適用）。
* **D_REST (2.0s)**: 釣り上げ、フッキング、またはリリース動作に伴う硬直時間。
* **C_CHUM (0.6)**: 撒き餌使用時のヒット時間短縮係数。
* **M_N{n}**: ルアー使用回数  に応じた重み倍率補正（）。

### 3.2 実効待機時間 () の計算式

魚がかかるまでの時間（Wait Time）は、ターゲット魚の基礎待機時間に撒き餌補正を掛けたものと、ルアーアクションによる物理的な拘束時間の「長い方」が適用される。

ここで、

* **補正バイト時間 ()**:
* 撒き餌あり (`isChum=true`): 
* 撒き餌なし (`isChum=false`): 


* **ルアー拘束時間 ()**:
* 
* ※ : ルアー使用回数 ()



### 3.3 1サイクル時間 ()

1回の試行（キャストから次キャスト可能になるまで）にかかる総時間。

---

## 4. ヒット率計算ロジック

ターゲット魚がヒットする確率 () は、魚種タイプ（通常/隠し）とシナリオ条件によって以下の通り算出される。

### 4.1 隠し魚 (`is_hidden: true`) の場合

マスタデータの `probabilities` テーブルから直接値を参照する。
v2.0より、参照キーには **新ID体系 (`n_d_g`)** が使用される。

### 4.2 通常魚 (`is_hidden: false`) の場合

同じ条件で出現しうる全魚種の「補正重み」を計算し、相対確率を求める。

1. **補正重み () の算出**:


* : 基礎重み。
* : ルアー使用回数に応じたボーナス ()。
* : トレード対象魚なら 、それ以外は 。


2. **隠し魚控除**:
そのシナリオ条件下で隠し魚が出現する確率の合計 () を  から差し引き、残りの確率枠を通常魚で分配する。

---

## 5. 戦略評価ロジック (v2.0 新機能)

単一の結果ではなく、「あるルール（戦略）に従って行動した結果」の平均値を算出する。

### 5.1 戦略の定義

戦略プリセットは、その戦略において到達しうる「終了シナリオID」のリスト (`eligible_scenarios`) として定義される。
例: 「L2固定」戦略なら、必ず2回振って終了する全てのパターン ( の全ID) がリストに含まれる。

### 5.2 期待値（加重平均）の算出

戦略に含まれる全てのシナリオ  について、以下の計算を行う。

**戦略平均サイクル時間 ():**


**戦略平均ヒット率 ():**


**戦略期待待機時間 ():**


ここで  は、そのシナリオ  が発生する確率である。

---

## 6. ID体系とデータ構造 (New ID System)

v2.0より、ルアーアクションの状態を一意に特定するため、従来の文字列ID（例: `p1_1_yes`）を廃止し、数値パラメータを含む新形式を採用する。

### 6.1 IDフォーマット

形式: **`n{N}_d{D}_g{G}`**

* **`n` (Number)**: ルアー使用総回数 ()。
* **`d` (Discovery)**: 隠し魚を発見した回数 (=なし, =1回目, =2回目...)。
* 仕様上、発見は1サイクルにつき最大1回のみ。


* **`g` (Guaranteed)**: 型確定が発生した回数の列挙 (=なし, =2回目, =2回目と3回目)。
* 複数回発生しうるため、数字を連結して表現する。



**例外ID:**

* **`none_0`**: ルアーアクションを使用せず、キャストのみを行う場合（素振り）。

### 6.2 IDの実例

| 新ID | 解析内容 | 旧ID相当（参考） |
| --- | --- | --- |
| `none_0` | 使用0, 発見なし, 型確なし | `none` |
| `n1_d1_g0` | 使用1, 1回目発見, 型確なし | `p1_1_yes` |
| `n2_d0_g2` | 使用2, 発見なし, 2回目型確 | `p2_2_guar` |
| `n3_d1_g23` | 使用3, 1回目発見, 2,3回目型確 | (新規定義) |

### 6.3 データ構造の変更

`logic_master.json` 内の `probabilities` オブジェクトにおいて、`hidden_hit_rates` はこの新IDをキーとするオブジェクトとして保持される。

```json
"hidden_hit_rates": {
  "n3_d1_g23": 19.35,
  "n2_d1_g0": 7.14,
  ...
}

```

---

## 7. UI（ユーザーインターフェース）仕様

画面構成はレスポンシブな3ペイン構成とし、モードによって表示内容を切り替える。

### 7.1 共通設定エリア（左ペイン上部）

* 釣り場、天気、餌、ターゲット魚、トレード対象、撒き餌の有無を選択。
* これらは全モードで共通して適用される。

### 7.2 モード切替タブ

以下の2つのモードをタブで切り替える。

1. **手動設定 (Manual Mode)**
* 従来の単一シナリオ詳細評価モード。
* 「ルアーシナリオ（新ID）」をプルダウンから選択する。


2. **戦略評価 (Strategy Mode)**
* v2.0追加モード。
* 2つの戦略プリセット（Strategy A / Strategy B）を選択し、その効率を比較する。



### 7.3 結果表示エリア（右ペイン）

* **単一評価**: 期待待機時間、ヒット率、サイクル時間をカード形式で表示。
* **戦略比較**: A/Bそれぞれの期待値を並列表示し、優劣を可視化する。

### 7.4 デバッグエリア（中央ペイン）

* 選択されたシナリオの詳細パラメータ（ の内訳など）を表示。
* データ不足や計算エラー時のメッセージ出力エリアとしても機能する。