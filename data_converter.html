<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>FLE Logic Master Converter v2.8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #0f172a;
            color: #f1f5f9;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
        }

        h1 {
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
            border: 2px dashed #334155;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            background: rgba(59, 130, 246, 0.05);
            transition: background 0.3s;
        }

        .input-group:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
        }

        input[type="file"] {
            display: none;
        }

        .custom-file-btn {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
        }

        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            margin-top: 20px;
            display: block;
            width: 100%;
            font-weight: bold;
        }

        button:disabled {
            background: #64748b;
            cursor: not-allowed;
        }

        button:hover:not(:disabled) {
            background: #059669;
        }

        #file-list {
            text-align: left;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #cbd5e1;
        }

        .file-item {
            margin: 5px 0;
            display: flex;
            align-items: center;
        }

        .icon-check {
            color: #10b981;
            margin-right: 8px;
            font-weight: bold;
        }

        .icon-cross {
            color: #ef4444;
            margin-right: 8px;
            font-weight: bold;
        }

        #status {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
            white-space: pre-wrap;
        }

        .error {
            color: #ef4444;
        }

        .success {
            color: #10b981;
        }

        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
            border-radius: 4px;
            margin-top: 20px;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>FLE Logic Master Converter <small>v2.8</small></h1>
        <p>æ—¥æœ¬èªãƒã‚¹ã‚¿CSVå°‚ç”¨ã‚³ãƒ³ãƒãƒ¼ã‚¿ (éš ã—é­šn1å¯¾å¿œç‰ˆ)</p>

        <div class="input-group">
            <label for="folderInput" class="custom-file-btn">ğŸ“‚ ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</label>
            <input type="file" id="folderInput" webkitdirectory directory multiple>
            <div id="file-list"></div>
        </div>

        <button id="convertBtn" onclick="generateJSON()" disabled>JSONç”Ÿæˆ & ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <div id="status"></div>
        <pre id="preview"></pre>
    </div>

    <script>
        const REQUIRED_FILES = {
            fish: "ãƒã‚¹ã‚¿ - 1_é­šç¨®.csv",
            hierarchy: "ãƒã‚¹ã‚¿ - 2_æ‹¡å¼µãƒ»ã‚¨ãƒªã‚¢å®šç¾©.csv",
            spots: "ãƒã‚¹ã‚¿ - 3_é‡£ã‚Šå ´å®šç¾©.csv",
            weights: "ãƒã‚¹ã‚¿ - 4_åŸºç¤é‡ã¿ãƒ»åŸºç¤å¾…æ©Ÿæ™‚é–“.csv",
            probs: "ãƒã‚¹ã‚¿ - 5_ç™ºè¦‹ãƒ»å‹ç¢ºå®šãƒ»éš ã—ãƒ’ãƒƒãƒˆç‡.csv",
            presets: "ãƒã‚¹ã‚¿ - 6_ãƒ«ã‚¢ãƒ¼æˆ¦ç•¥ãƒ—ãƒªã‚»ãƒƒãƒˆ.csv"
        };

        let foundFiles = {};

        document.getElementById('folderInput').addEventListener('change', function (e) {
            const files = e.target.files;
            foundFiles = {};
            const fileListEl = document.getElementById('file-list');
            fileListEl.innerHTML = '';

            for (let file of files) {
                for (let key in REQUIRED_FILES) {
                    if (file.name === REQUIRED_FILES[key]) {
                        foundFiles[key] = file;
                    }
                }
            }

            let allFound = true;
            for (let key in REQUIRED_FILES) {
                const name = REQUIRED_FILES[key];
                const isFound = foundFiles[key] !== undefined;
                if (!isFound) allFound = false;

                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = isFound
                    ? `<span class="icon-check">âœ”</span> ${name}`
                    : `<span class="icon-cross">âœ–</span> ${name}`;
                fileListEl.appendChild(div);
            }

            const btn = document.getElementById('convertBtn');
            const status = document.getElementById('status');
            if (allFound) {
                btn.disabled = false;
                status.textContent = "æº–å‚™å®Œäº†";
                status.className = "success";
            } else {
                btn.disabled = true;
                status.textContent = "ä¸è¶³ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™";
                status.className = "error";
            }
        });

        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                if (!file) return resolve([]);
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: (err) => reject(err)
                });
            });
        }

        async function generateJSON() {
            const statusEl = document.getElementById('status');
            const previewEl = document.getElementById('preview');
            statusEl.textContent = "å¤‰æ›å‡¦ç†ä¸­...";
            statusEl.className = "";
            previewEl.textContent = "";

            try {
                const [fishData, hierarchyData, spotsData, weightsData, probsData, presetsData] = await Promise.all([
                    parseCSV(foundFiles.fish),
                    parseCSV(foundFiles.hierarchy),
                    parseCSV(foundFiles.spots),
                    parseCSV(foundFiles.weights),
                    parseCSV(foundFiles.probs),
                    parseCSV(foundFiles.presets)
                ]);

                // --- 1. Master Object ---
                const master = {
                    version: "2.8.0",
                    updated_at: new Date().toISOString(),
                    fish: {},
                    spots: {},
                    weights: {},
                    probabilities: [],
                    strategy_presets: []
                };

                // --- 2. Initialize Spots from Hierarchy ---
                const hierarchyMap = {};
                hierarchyData.forEach(row => {
                    const spot = row['é‡£ã‚Šå ´'];
                    if (spot) {
                        hierarchyMap[spot] = { expansion: row['æ‹¡å¼µ'], area: row['ã‚¨ãƒªã‚¢'] };
                        master.spots[spot] = {
                            expansion: row['æ‹¡å¼µ'],
                            area: row['ã‚¨ãƒªã‚¢'],
                            weathers: [],
                            baits: [],
                            fish_list: []
                        };
                    }
                });

                // --- 3. Process Fish ---
                const typeMap = { "å°å‹": "small_jaws", "å¤§å‹": "large_jaws", "ä¸­å‹": "medium_jaws" };
                fishData.forEach(row => {
                    if (!row['é­šç¨®']) return;
                    master.fish[row['é­šç¨®']] = {
                        type: typeMap[row['å‹']] || "small_jaws",
                        vibration: row['æ¼”å‡º'],
                        hook_time: parseFloat(row['é‡£ã‚Šä¸Šã’å‹•ä½œæ™‚é–“']),
                        is_hidden: (row['éš ã—åˆ¤å®š'] == '1'),
                        can_trade: (row['ãƒˆãƒ¬ãƒ¼ãƒ‰å¯å¦'] == '1')
                    };
                });

                // --- 4. Process Spots Details (Aggregation) ---
                spotsData.forEach(row => {
                    const spot = row['é‡£ã‚Šå ´'];
                    const type = row['ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥'];
                    const data = row['ãƒ‡ãƒ¼ã‚¿'];
                    if (!spot || !type || !data) return;

                    if (!master.spots[spot]) {
                        master.spots[spot] = {
                            expansion: "ãã®ä»–", area: "ä¸æ˜",
                            weathers: [], baits: [], fish_list: []
                        };
                    }

                    if (type === 'å¤©æ°— / æ™‚é–“') master.spots[spot].weathers.push(data);
                    else if (type === 'é¤Œ') master.spots[spot].baits.push(data);
                    else if (type === 'é­šç¨®') master.spots[spot].fish_list.push(data);
                });

                // --- 5. Process Weights ---
                weightsData.forEach(row => {
                    const key = `${row['é‡£ã‚Šå ´']}|${row['å¤©æ°— / æ™‚é–“']}|${row['é¤Œ']}`;
                    if (!master.weights[key]) master.weights[key] = [];
                    master.weights[key].push({
                        fish: row['é­šç¨®'],
                        weight: parseFloat(row['åŸºç¤é‡ã¿']),
                        bite_time: parseFloat(row['åŸºç¤å¾…æ©Ÿæ™‚é–“'])
                    });
                });

                // --- 6. Process Probabilities ---
                // ã€ä¿®æ­£ã€‘ã‚­ãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¿®æ­£ (v2.8)
                const hiddenHitMap = {
                    'ç™ºè¦‹1å‹ç¢º1ãªã—éš ã—ãƒ’ãƒƒãƒˆç‡1': 'n1_d1_g0', // ã€ä¿®æ­£ã€‘n2 -> n1
                    'ç™ºè¦‹1å‹ç¢º2ã‚ã‚Šéš ã—ãƒ’ãƒƒãƒˆç‡2': 'n2_d1_g2',
                    'ç™ºè¦‹1å‹ç¢º2ãªã—éš ã—ãƒ’ãƒƒãƒˆç‡2': 'n2_d1_g0',
                    'ç™ºè¦‹1å‹ç¢º3ã‚ã‚Šéš ã—ãƒ’ãƒƒãƒˆç‡3': 'n3_d1_g3',
                    'ç™ºè¦‹1å‹ç¢º3ãªã—éš ã—ãƒ’ãƒƒãƒˆç‡3': 'n3_d1_g0',
                    'ç™ºè¦‹2å‹ç¢º2ãªã—éš ã—ãƒ’ãƒƒãƒˆç‡2': 'n2_d2_g0',
                    'ç™ºè¦‹2å‹ç¢º3ã‚ã‚Šéš ã—ãƒ’ãƒƒãƒˆç‡3': 'n3_d2_g3',
                    'ç™ºè¦‹2å‹ç¢º3ãªã—éš ã—ãƒ’ãƒƒãƒˆç‡3': 'n3_d2_g0',
                    'ç™ºè¦‹3å‹ç¢º3ãªã—éš ã—ãƒ’ãƒƒãƒˆç‡3': 'n3_d3_g0'
                };

                probsData.forEach(row => {
                    const parsePercent = (val) => {
                        if (!val) return null;
                        const num = parseFloat(val.replace('%', ''));
                        return isNaN(num) ? null : num;
                    };
                    const discRates = [parsePercent(row['ç™ºè¦‹ç‡1']), parsePercent(row['ç™ºè¦‹ç‡2']), parsePercent(row['ç™ºè¦‹ç‡3'])];
                    const guarRatesNoDisc = [parsePercent(row['æœªç™ºè¦‹å‹ç¢ºå®šç‡1']), parsePercent(row['æœªç™ºè¦‹å‹ç¢ºå®šç‡2']), parsePercent(row['æœªç™ºè¦‹å‹ç¢ºå®šç‡3'])];

                    const guarRatesAfter = {};
                    const addGA = (k, v) => { if (v) guarRatesAfter[k] = parsePercent(v); };
                    addGA('d1_g2', row['ç™ºè¦‹1å‹ç¢ºå®šç‡2']);
                    addGA('d1_g3', row['ç™ºè¦‹1å‹ç¢ºå®šç‡3']);
                    addGA('d2_g3', row['ç™ºè¦‹2å‹ç¢ºå®šç‡3']);

                    const hiddenHit = {};
                    Object.keys(hiddenHitMap).forEach(header => {
                        if (row[header]) hiddenHit[hiddenHitMap[header]] = parsePercent(row[header]);
                    });

                    master.probabilities.push({
                        spot: row['é‡£ã‚Šå ´'],
                        weather: row['å¤©æ°— / æ™‚é–“'],
                        bait: row['é¤Œ'],
                        target_hidden: row['å¯¾è±¡éš ã—é­š'] === 'ãªã—' ? null : row['å¯¾è±¡éš ã—é­š'],
                        trade_target: row['ãƒˆãƒ¬ãƒ¼ãƒ‰å¯¾è±¡'],
                        lure_type: row['ãƒ«ã‚¢ãƒ¼ç¨®é¡'],
                        disc_rates: discRates,
                        guar_rates_nodisc: guarRatesNoDisc,
                        guar_rates_after_disc: guarRatesAfter,
                        hidden_hit_rates: hiddenHit
                    });
                });

                // --- 7. Process Presets ---
                presetsData.forEach(row => {
                    if (!row['æˆ¦ç•¥ID']) return;
                    const scenarios = [];
                    Object.keys(row).forEach(k => {
                        if (k !== 'æˆ¦ç•¥ID' && k !== 'æˆ¦ç•¥å' && k !== 'èª¬æ˜' && row[k] == '1') {
                            scenarios.push(k);
                        }
                    });
                    master.strategy_presets.push({
                        id: row['æˆ¦ç•¥ID'],
                        name: row['æˆ¦ç•¥å'],
                        description: row['èª¬æ˜'],
                        eligible_scenarios: scenarios
                    });
                });

                // --- Output ---
                const jsonStr = JSON.stringify(master, null, 2);
                previewEl.textContent = jsonStr.slice(0, 1000) + "... (çœç•¥)";
                const blob = new Blob([jsonStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "logic_master.json";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                statusEl.textContent = "å¤‰æ›æˆåŠŸï¼\nlogic_master.json ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚";
                statusEl.className = "success";

            } catch (err) {
                console.error(err);
                statusEl.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n" + err.message;
                statusEl.className = "error";
            }
        }
    </script>
</body>

</html>